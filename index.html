<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ - –°–∞–∫—É—Ä–∞</title>
    <link rel="icon" href="https://iili.io/3soEozX.png"/>
    <style>
        :root {
            --bg-color: #fff5f7;
            --text-color: #4a2f3b;
            --button-bg: #f8b8c6;
            --button-hover: #ffb6c1;
            --column-bg: rgba(255, 245, 247, 0.9);
            --border-color: #f4c4ce;
            --trash-bg: #ff6b6b;
            --trash-hover: #ff5252;
            --notification-bg: #ff8c94;
            --gradient-light: linear-gradient(145deg, #fff0f5, #ffe4e9);
            --gradient-dark: linear-gradient(145deg, #4a2f3b, #6b4e5a);
            --shadow-light: 5px 5px 15px rgba(244, 196, 206, 0.2), -5px -5px 15px rgba(255, 255, 255, 0.7);
            --shadow-dark: 5px 5px 15px rgba(74, 47, 59, 0.3), -5px -5px 15px rgba(255, 255, 255, 0.05);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            --bg-image: url('https://iili.io/3i4Bo2R.webp');
            background-color: var(--bg-color);
            background-image: var(--bg-image), var(--gradient-light, none);
            background-attachment: fixed;
            background-size: cover, auto;
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.4s ease-in-out;
            margin: 0;
            min-height: 100vh;
            padding-bottom: 0px;
            position: relative;
            overflow-x: hidden;
        }

        .petals {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffb6c1;
            border-radius: 50% 20%;
            opacity: 0.7;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0.7; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0.2; }
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            padding: 15px;
            background: var(--column-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        input {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: var(--shadow-light);
            width: 210px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus {
            outline: 2px solid var(--button-bg);
            box-shadow: 0 0 8px rgba(248, 184, 198, 0.3);
        }

        button {
            position: relative;
            padding: 12px 24px;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        body.dark button {
            color: #fff;
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 0px 10px rgba(248, 184, 198, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 15px;
        }

        .column {
            padding: 20px;
            border-radius: 15px;
            background-color: var(--column-bg);
            box-shadow: var(--shadow-light);
            overflow-y: auto;
            max-height: 600px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            padding-top: 50px;
        }

        .column h2 {
            text-align: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: var(--column-bg);
            z-index: 2;
            padding: 10px;
            font-size: 20px;
        }

        .column.dragover {
            border-color: var(--button-hover);
            transform: scale(1.01);
            background: rgba(248, 184, 198, 0.1);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            min-height: 100px;
        }

        button.pending { background-color: #f8b8c6; }
        button.completed { background-color: #e0d0d5; }
        button.deferred { background-color: #ff8c94; }
        button.dragging { opacity: 0.6; transform: scale(0.95); }

        button .timer-container {
            position: absolute;
            top: 6px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        button .timer {
            font-size: 12px;
            background-color: rgba(74, 47, 59, 0.6);
            padding: 3px 7px;
            border-radius: 8px;
            color: #fff;
        }

        button .edit-time-btn {
            font-size: 12px;
            background-color: #ff8c94;
            border-radius: 6px;
            padding: 2px 6px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button .edit-time-btn:hover {
            background-color: #ff6b6b;
        }

        .timer-control {
            margin: 6px 3px 0;
            font-size: 12px;
            padding: 4px 10px;
            background-color: #4a2f3b;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        .timer-control:hover {
            background-color: #6b4e5a;
        }

        .trash-bin {
            width: 250px;
            height: 50px;
            background-color: var(--trash-bg);
            color: white;
            text-align: center;
            line-height: 50px;
            font-size: 16px;
            border-radius: 10px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .trash-bin:hover,
        .trash-bin.dragover {
            background-color: var(--trash-hover);
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: var(--notification-bg);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            font-size: 16px;
            box-shadow: var(--shadow-light);
        }

        .notification.show {
            display: block;
            animation: fadeInOut 3s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(20px); }
        }

        .clear-btn-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            padding: 15px;
        }

        .clear-btn {
            padding: 12px;
            background-color: var(--trash-bg);
            color: white;
            border: none;
            font-size: 14px;
            border-radius: 10px;
            flex: 1;
            max-width: 200px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background-color: var(--trash-hover);
            transform: translateY(-2px);
        }

        body.dark {
            --bg-color: #2f1b24;
            --text-color: #f4c4ce;
            --button-bg: #e07b8c;
            --button-hover: #f8b8c6;
            --column-bg: rgba(47, 27, 36, 0.9);
            --border-color: #6b4e5a;
            --trash-bg: #c62828;
            --trash-hover: #b71c1c;
            --notification-bg: #ff6b6b;
            --gradient-light: var(--gradient-dark, none);
            --shadow-light: var(--shadow-dark, none);
            --bg-image: url('https://iili.io/3i4BqBa.webp');
        }

        .selected {
            outline: 3px solid #ff8c94;
            background-color: rgba(255, 140, 148, 0.15);
            box-shadow: 0 0 12px rgba(255, 140, 148, 0.5);
            transform: scale(1.02);
        }

        .counter {
            position: absolute;
            top: 10px;
            right: 15px;
            font-weight: bold;
            font-size: 16px;
            color: #fff;
            background-color: var(--button-bg);
            padding: 5px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark .counter {
            background-color: var(--button-bg);
            color: #fff;
        }

        .add-button {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .add-button:hover {
            transform: none;
            background: #fff;
            color: #000;
        }

        .sidebar-toggle {
            position: fixed;
            top: 35px;
            left: 0px;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1100;
            padding: 0;
            transition: left 0.3s ease-in-out;
            border-radius: 0 10px 10px 0;
        }

        .sidebar-toggle.open {
            left: 300px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--column-bg);
            box-shadow: var(--shadow-light);
            padding: 20px;
            z-index: 1050;
            transition: left 0.3s ease-in-out;
            overflow-y: auto;
        }
        .sidebar input {
            width: 100%;    
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chekmarkbox {
            display: flex;
        }

        .chekmarkbox > input {
            width: 16px;
            margin-right: 10px;
        }

        .name-item {
            display: grid;
            grid-template-columns: 60% 30%;
        }

        .name-item > button {
            font-size: 12px;
            padding: 8px 16px;
        }

        .name-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .name-item:last-child {
            border-bottom: none;
        }

        .result-textarea {
            width: 100%;
            height: 100px;
            resize: none;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: var(--shadow-light);
        }

        .activity-log {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            box-shadow: var(--shadow-light);
        }

        .activity-log h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .activity-log ul {
            list-style: none;
            padding: 0;
        }

        .activity-log li {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .activity-log li:last-child {
            border-bottom: none;
        }

        .login-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--column-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow-light), 0 0 20px rgba(248, 184, 198, 0.3);
            width: 350px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .login-container:hover {
            box-shadow: var(--shadow-light), 0 0 30px rgba(248, 184, 198, 0.5);
        }

        .login-container h2 {
            margin-bottom: 25px;
            font-size: 26px;
            color: var(--text-color);
        }

        .login-container input {
            width: 100%;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
        }

        .login-container button {
            width: 100%;
            background: linear-gradient(145deg, var(--button-bg), var(--button-hover));
            box-shadow: 0 4px 8px rgba(248, 184, 198, 0.3);
        }

        .user-info {
            position: fixed;
            top: 0px;
            right: 0px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--column-bg);
            padding: 10px 15px;
            border-radius: 0 0 0 10px;
            box-shadow: var(--shadow-light);
            z-index: 120;
        }

        .user-info span {
            font-weight: bold;
        }

        .user-info button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--column-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            width: 300px;
            text-align: center;
            border: 1px solid var(--border-color);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--text-color);
        }

        .time-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-inputs input {
            width: 60px;
            padding: 8px;
            text-align: center;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
        }

        .number-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 16px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 15px auto; }
            .controls { flex-direction: column; align-items: center; padding: 10px; }
            input { width: 100%; max-width: 300px; }
            .columns { grid-template-columns: 1fr; gap: 15px; }
            .column { width: 100%; max-height: 500px; }
            .clear-btn { width: 100%; max-width: none; }
            .trash-bin { width: 200px; height: 45px; line-height: 45px; font-size: 14px; right: 10px; bottom: 10px; }
            .notification { bottom: 70px; right: 10px; max-width: 90%; }
            .sidebar { width: 250px; }
            .sidebar.open { left: 0; }
            .sidebar-toggle { width: 40px; height: 40px; font-size: 20px; }
            .login-container { width: 90%; padding: 30px; border-radius: 15px; }
            .user-info { top: 0px; right: 0px; flex-direction: row; gap: 5px; padding: 8px; border-radius: 0 0 0 10px; }
            .modal-content { width: 90%; max-width: 280px; }
            .time-inputs input { width: 50px; font-size: 14px; }
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--column-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border-radius: 10px;
            border: 2px solid var(--column-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--button-hover);
        }

        body.dark ::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border: 2px solid var(--column-bg);
        }

        body.dark ::-webkit-scrollbar-thumb:hover {
            background-color: var(--button-hover);
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE_URL = "https://otp-2-fos4.onrender.com";

        const App = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [buttons, setButtons] = useState({ pending: [], completed: [], deferred: [] });
            const [notification, setNotification] = useState({ show: false, message: '' });
            const [fromValue, setFromValue] = useState('');
            const [toValue, setToValue] = useState('');
            const [stepValue, setStepValue] = useState(1);
            const [selectedButtons, setSelectedButtons] = useState([]);
            const [showTimerModal, setShowTimerModal] = useState(null);
            const [timerHours, setTimerHours] = useState('');
            const [timerMinutes, setTimerMinutes] = useState('');
            const [timerSeconds, setTimerSeconds] = useState('');
            const [showAddButtonModal, setShowAddButtonModal] = useState(false);
            const [newButtonNumber, setNewButtonNumber] = useState('');
            const [startButton, setStartButton] = useState('');
            const [activeOperators, setActiveOperators] = useState([]);
            const [result, setResult] = useState('');
            const [isDividing, setIsDividing] = useState(false);
            const [isFetchingOperators, setIsFetchingOperators] = useState(false);
            const [month, setMonth] = useState('');
            const [isGeneratingReport, setIsGeneratingReport] = useState(false);
            const [loggedIn, setLoggedIn] = useState(false);
            const [loginValue, setLoginValue] = useState('');
            const [passwordValue, setPasswordValue] = useState('');
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [userData, setUserData] = useState(null);
            const [isTogglingActive, setIsTogglingActive] = useState(false);
            const [activities, setActivities] = useState([]); // New state for activity logs
            const [isFetchingActivities, setIsFetchingActivities] = useState(false); // New state for loading activities

            const timersRef = useRef(new Map());
            const petalsRef = useRef(null);

            useEffect(() => {
                document.body.classList.toggle('dark', theme === 'dark');
                localStorage.setItem('theme', theme);
            }, [theme]);

            useEffect(() => {
                createPetals();
                loadButtonsFromLocalStorage();
                checkLoginStatus();
            }, []);

            useEffect(() => {
                if (userData && userData.role === 'operator') {
                    fetchActivities(); // Automatically load activities for operators on login
                }
            }, [userData]);

            const checkLoginStatus = () => {
                const apiKey = localStorage.getItem('apiKey');
                const userId = localStorage.getItem('userId');
                if (apiKey && userId) {
                    setLoggedIn(true);
                    setUserData({ id: userId, ...JSON.parse(localStorage.getItem('userData') || '{}') });
                }
            };

            const handleLogin = async () => {
                setIsLoggingIn(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ login: loginValue, password: passwordValue })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        localStorage.setItem('apiKey', data.apiKey);
                        localStorage.setItem('userId', data.id);
                        localStorage.setItem('userData', JSON.stringify({
                            name: data.name,
                            role: data.role,
                            isActive: false // Initial state, will be updated if needed
                        }));
                        setLoggedIn(true);
                        setUserData({
                            name: data.name,
                            role: data.role,
                            isActive: false
                        });
                        showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                    }
                } catch (e) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                } finally {
                    setIsLoggingIn(false);
                }
            };

            const handleLogout = () => {
                localStorage.clear();
                setLoggedIn(false);
                setUserData(null);
                setButtons({ pending: [], completed: [], deferred: [] });
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
            };

            const toggleActive = async (newActive) => {
                setIsTogglingActive(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/user/toggle_active`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': localStorage.getItem('apiKey'),
                            'X-User-Id': localStorage.getItem('userId')
                        },
                        body: JSON.stringify({ is_active: newActive })
                    });
                    const data = await res.json();
                    if (data.status === 'success' || data.status === 'unchanged') {
                        setUserData(prev => ({ ...prev, isActive: newActive }));
                        showNotification(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${newActive ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω'}`);
                        fetchActivities(); // Reload activities after toggle
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                    }
                } catch (e) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                } finally {
                    setIsTogglingActive(false);
                }
            };

            const fetchActiveOperators = async () => {
                setIsFetchingOperators(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/active_operators`, {
                        headers: {
                            'X-API-Key': localStorage.getItem('apiKey')
                        }
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setActiveOperators(data.operators);
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤');
                    }
                } catch (e) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                } finally {
                    setIsFetchingOperators(false);
                }
            };

            const generateReport = async () => {
                setIsGeneratingReport(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/report/monthly?month=${month}`, {
                        headers: {
                            'X-API-Key': localStorage.getItem('apiKey'),
                            'X-User-Id': localStorage.getItem('userId')
                        }
                    });
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `monthly_report_${month}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        showNotification('–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
                    } else {
                        const data = await res.json();
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
                    }
                } catch (e) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                } finally {
                    setIsGeneratingReport(false);
                }
            };

            const createPetals = () => {
                const petalsContainer = petalsRef.current;
                if (!petalsContainer) return;
                for (let i = 0; i < 20; i++) {
                    const petal = document.createElement('div');
                    petal.className = 'petal';
                    petal.style.left = `${Math.random() * 100}vw`;
                    petal.style.animationDuration = `${Math.random() * 10 + 5}s`;
                    petal.style.animationDelay = `${Math.random() * 5}s`;
                    petalsContainer.appendChild(petal);
                }
            };

            const toggleTheme = () => {
                setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            };

            const toggleSidebar = () => {
                setSidebarOpen(prev => !prev);
            };

            const loadButtonsFromLocalStorage = () => {
                const savedButtons = localStorage.getItem('buttons');
                if (savedButtons) {
                    setButtons(JSON.parse(savedButtons));
                }
                timersRef.current.forEach((interval, id) => clearInterval(interval));
                timersRef.current.clear();
                const savedTimers = Object.keys(localStorage).filter(key => key.startsWith('timer_'));
                savedTimers.forEach(key => {
                    const id = key.replace('timer_', '');
                    const endTime = parseInt(localStorage.getItem(key));
                    if (endTime > Date.now()) {
                        startTimer(id, (endTime - Date.now()) / 1000, false);
                    }
                });
            };

            const saveButtonsToLocalStorage = () => {
                localStorage.setItem('buttons', JSON.stringify(buttons));
            };

            useEffect(() => {
                saveButtonsToLocalStorage();
            }, [buttons]);

            const showNotification = (message) => {
                setNotification({ show: true, message });
                setTimeout(() => setNotification({ show: false, message: '' }), 3000);
            };

            const addButtons = () => {
                const from = parseInt(fromValue);
                const to = parseInt(toValue);
                const step = parseInt(stepValue) || 1;
                if (isNaN(from) || isNaN(to)) return showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞!');
                const newBtns = [];
                for (let i = from; i <= to; i += step) {
                    const id = `btn-${i}-${Date.now()}`;
                    newBtns.push({ id, num: i });
                }
                setButtons(prev => ({ ...prev, pending: [...prev.pending, ...newBtns] }));
                showNotification('–ö–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã!');
                setFromValue('');
                setToValue('');
            };

            const addSingleDeferredButton = () => {
                const num = parseInt(newButtonNumber);
                if (isNaN(num) || num < 1) return showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä!');
                const id = `btn-${num}-${Date.now()}`;
                setButtons(prev => ({ ...prev, deferred: [...prev.deferred, { id, num }] }));
                showNotification('–ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ!');
                setShowAddButtonModal(false);
                setNewButtonNumber('');
            };

            const startTimer = (id, durationSeconds = 900, save = true) => {
                const endTime = Date.now() + durationSeconds * 1000;
                if (save) localStorage.setItem(`timer_${id}`, endTime);
                const interval = setInterval(() => {
                    const remaining = Math.max(0, (endTime - Date.now()) / 1000);
                    const hours = Math.floor(remaining / 3600);
                    const minutes = Math.floor((remaining % 3600) / 60);
                    const seconds = Math.floor(remaining % 60);
                    const timerElement = document.getElementById(`timer-${id}`);
                    if (timerElement) {
                        timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                    if (remaining <= 0) {
                        clearInterval(interval);
                        timersRef.current.delete(id);
                        localStorage.removeItem(`timer_${id}`);
                    }
                }, 1000);
                timersRef.current.set(id, interval);
            };

            const promptForCustomTime = (id) => {
                setShowTimerModal(id);
            };

            const submitCustomTime = (id) => {
                const hours = parseInt(timerHours) || 0;
                const minutes = parseInt(timerMinutes) || 0;
                const seconds = parseInt(timerSeconds) || 0;
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                if (totalSeconds <= 0) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è!');
                    return;
                }
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                startTimer(id, totalSeconds);
                setShowTimerModal(null);
                setTimerHours('');
                setTimerMinutes('');
                setTimerSeconds('');
            };

            const restartTimer = (id) => {
                let restartCount = parseInt(localStorage.getItem(`restartCount_${id}`) || '0');
                restartCount++;
                localStorage.setItem(`restartCount_${id}`, restartCount);
                const duration = restartCount === 1 ? 1800 : 3600;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                startTimer(id, duration);
                setButtons(prev => ({ ...prev }));
            };

            const completeTask = (id, column) => {
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                setButtons(prev => {
                    const btn = prev.deferred.find(b => b.id === id);
                    if (!btn) return prev;
                    return {
                        ...prev,
                        deferred: prev.deferred.filter(b => b.id !== id),
                        completed: [...prev.completed, btn]
                    };
                });
            };

            const handleButtonClick = (e, btn, column) => {
                if (e.ctrlKey || e.metaKey) {
                    setSelectedButtons(prev => prev.some(s => s.id === btn.id) ? prev.filter(s => s.id !== btn.id) : [...prev, {...btn, column}]);
                } else {
                    setSelectedButtons([{...btn, column}]);
                }
            };

            const openSelectedInTabs = () => {
                if (selectedButtons.length === 0) return showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–æ–ø–∫—É!');
                selectedButtons.forEach(btn => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank'));
            };

            const deleteButton = (btn) => {
                if (!confirm('–£–≤–µ—Ä–µ–Ω—ã?')) return;
                const id = btn.id;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                timersRef.current.delete(id);
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    Object.keys(newButtons).forEach(col => {
                        newButtons[col] = newButtons[col].filter(b => b.id !== id);
                    });
                    return newButtons;
                });
                setSelectedButtons(prev => prev.filter(s => s.id !== id));
                showNotification('–ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞!');
            };

            const dragStart = (e, btn) => {
                e.dataTransfer.setData('text/plain', JSON.stringify(btn));
                e.target.classList.add('dragging');
            };

            const dragEnd = (e) => {
                e.target.classList.remove('dragging');
            };

            const allowDrop = (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            };

            const drop = (e, targetColumn) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                setSelectedButtons([]);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    selectedButtons.forEach(selBtn => {
                        Object.keys(newButtons).forEach(col => {
                            newButtons[col] = newButtons[col].filter(b => b.id !== selBtn.id);
                        });
                        newButtons[targetColumn].push(selBtn);
                        if (targetColumn === 'deferred') {
                            startTimer(selBtn.id, 900);
                        } else if (selBtn.column === 'deferred') {
                            if (timersRef.current.has(selBtn.id)) clearInterval(timersRef.current.get(selBtn.id));
                            timersRef.current.delete(selBtn.id);
                            localStorage.removeItem(`timer_${selBtn.id}`);
                            localStorage.removeItem(`restartCount_${selBtn.id}`);
                        }
                    });
                    return newButtons;
                });
            };

            const dropInTrash = (e) => {
                e.preventDefault();
                document.getElementById('trashBin').classList.remove('dragover');
                selectedButtons.forEach(selBtn => deleteButton(selBtn));
            };

            const clearColumn = (columnId) => {
                buttons[columnId].forEach(btn => {
                    if (timersRef.current.has(btn.id)) clearInterval(timersRef.current.get(btn.id));
                    timersRef.current.delete(btn.id);
                    localStorage.removeItem(`timer_${btn.id}`);
                    localStorage.removeItem(`restartCount_${btn.id}`);
                });
                setButtons(prev => ({ ...prev, [columnId]: [] }));
                showNotification(`–ö–æ–ª–æ–Ω–∫–∞ "${columnId}" –æ—á–∏—â–µ–Ω–∞!`);
            };

            const divideButtons = async () => {
                setIsDividing(true);
                await fetchActiveOperators();
                const start = parseInt(startButton);
                if (isNaN(start) || start < 1) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä!');
                    setIsDividing(false);
                    return;
                }
                if (activeOperators.length === 0) {
                    showNotification('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤!');
                    setIsDividing(false);
                    return;
                }
                const res = activeOperators.map((op, index) => `${start + index} - ${op.name.split(' ')[1]}`).join('\n');
                setResult(res);
                showNotification('–¢–∏–∫–µ—Ç—ã –ø–æ–¥–µ–ª–µ–Ω—ã!');
                setIsDividing(false);
            };

            const copyResult = () => {
                navigator.clipboard.writeText(result);
                showNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            };

            const fetchActivities = async () => {
                setIsFetchingActivities(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/activity_logs/current_day`, {
                        headers: {
                            'X-API-Key': localStorage.getItem('apiKey'),
                            'X-User-Id': localStorage.getItem('userId')
                        }
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        setActivities(data.activities || []);
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
                    }
                } catch (e) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                } finally {
                    setIsFetchingActivities(false);
                }
            };

            const renderButton = (btn, column) => {
                const id = btn.id;
                const endTime = localStorage.getItem(`timer_${id}`);
                const hasTimer = column === 'deferred' && endTime && (parseInt(endTime) > Date.now());
                const showControls = column === 'deferred' && !hasTimer;
                const isSelected = selectedButtons.some(s => s.id === id);
                return (
                    <button
                        key={id}
                        id={id}
                        className={`${column} ${isSelected ? 'selected' : ''}`}
                        draggable
                        onDragStart={(e) => dragStart(e, btn)}
                        onDragEnd={dragEnd}
                        onClick={(e) => handleButtonClick(e, btn, column)}
                        onDoubleClick={() => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank')}
                        onContextMenu={(e) => { e.preventDefault(); deleteButton(btn); }}
                    >
                        –ö–Ω–æ–ø–∫–∞ {btn.num}
                        {column === 'deferred' && (
                            <div className="timer-container">
                                {hasTimer && (
                                    <>
                                        <div className="timer" id={`timer-${id}`}></div>
                                        <button className="edit-time-btn" onClick={() => promptForCustomTime(id)}>üñãÔ∏è</button>
                                    </>
                                )}
                            </div>
                        )}
                        {showControls && (
                            <>
                                <button className="timer-control" onClick={() => restartTimer(id)}>‚Üª</button>
                                <button className="timer-control" onClick={() => completeTask(id, column)}>‚úî</button>
                            </>
                        )}
                    </button>
                );
            };

            if (!loggedIn) {
                return (
                    <div className="login-container">
                        <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                        <input type="text" value={loginValue} onChange={(e) => setLoginValue(e.target.value)} placeholder="–õ–æ–≥–∏–Ω" />
                        <input type="password" value={passwordValue} onChange={(e) => setPasswordValue(e.target.value)} placeholder="–ü–∞—Ä–æ–ª—å" />
                        <button onClick={handleLogin} disabled={isLoggingIn}>
                            {isLoggingIn ? <div className="loader"></div> : '–í–æ–π—Ç–∏'}
                        </button>
                        <div className={`notification ${notification.show ? 'show' : ''}`}>{notification.message}</div>
                    </div>
                );
            }

            return (
                <>
                    <div className="petals" ref={petalsRef}></div>
                    <button className={`sidebar-toggle ${sidebarOpen ? 'open' : ''}`} onClick={toggleSidebar} aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫">üìù</button>
                    <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-content">
                            {userData.role === 'operator' && (
                                <>
                                    <button onClick={() => toggleActive(!userData.isActive)} disabled={isTogglingActive}>
                                        {isTogglingActive ? <div className="loader"></div> : (userData.isActive ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å')}
                                    </button>
                                    <div className="activity-log">
                                        <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è</h3>
                                        <button onClick={fetchActivities} disabled={isFetchingActivities}>
                                            {isFetchingActivities ? <div className="loader"></div> : '–û–±–Ω–æ–≤–∏—Ç—å'}
                                        </button>
                                        <ul>
                                            {activities.length > 0 ? (
                                                activities.map((act, index) => (
                                                    <li key={index}>
                                                        {act.start}: {act.status} ({act.duration})
                                                    </li>
                                                ))
                                            ) : (
                                                <li>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</li>
                                            )}
                                        </ul>
                                    </div>
                                </>
                            )}
                            <input type="number" value={startButton} onChange={(e) => setStartButton(e.target.value)} placeholder="–ù–∞—á–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞" />
                            <button onClick={divideButtons} disabled={isDividing || isFetchingOperators}>
                                {isDividing || isFetchingOperators ? <div className="loader"></div> : '–ü–æ–¥–µ–ª–∏—Ç—å'}
                            </button>
                            <textarea className="result-textarea" value={result} readOnly />
                            <button onClick={copyResult}>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            {userData.role !== 'operator' && (
                                <>
                                    <input 
                                        type="month" 
                                        value={month} 
                                        onChange={(e) => setMonth(e.target.value)} 
                                        placeholder="–ú–µ—Å—è—Ü YYYY-MM" 
                                    />
                                    <button onClick={generateReport} disabled={isGeneratingReport}>
                                        {isGeneratingReport ? <div className="loader"></div> : '–û—Ç—á–µ—Ç'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    {userData && (
                        <div className="user-info">
                            <span>{userData.name}</span>
                            <button onClick={handleLogout}>–í—ã–π—Ç–∏</button>
                        </div>
                    )}
                    <div className="container">
                        <div className="controls">
                            <button onClick={toggleTheme} aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                                <span>{theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}</span>
                            </button>
                            <input type="number" value={fromValue} onChange={(e) => setFromValue(e.target.value)} placeholder="–° –∫–∞–∫–æ–π –∫–Ω–æ–ø–∫–∏" />
                            <input type="number" value={toValue} onChange={(e) => setToValue(e.target.value)} placeholder="–î–æ –∫–∞–∫–æ–π –∫–Ω–æ–ø–∫–∏" />
                            <input type="number" value={stepValue} onChange={(e) => setStepValue(e.target.value)} placeholder="–®–∞–≥" />
                            <button onClick={addButtons} aria-label="–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏</button>
                            <button onClick={openSelectedInTabs} aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ">–û—Ç–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                        </div>
                        <div className="columns">
                            {['pending', 'completed', 'deferred'].map(column => (
                                <div
                                    key={column}
                                    className="column"
                                    id={column}
                                    onDrop={(e) => drop(e, column)}
                                    onDragOver={allowDrop}
                                    onDragLeave={(e) => e.currentTarget.classList.remove('dragover')}
                                >
                                    <h2>{column === 'pending' ? '–í—ã–ø–æ–ª–Ω—è–µ–º—ã–µ' : column === 'completed' ? '–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ' : '–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ'}</h2>
                                    <div className="list" id={`${column}List`}>
                                        {buttons[column].map(btn => renderButton(btn, column))}
                                    </div>
                                    <div className="counter" id={`${column}Count`}>
                                        {buttons[column].length}
                                        {column === 'deferred' && (
                                            <button className="add-button" onClick={() => setShowAddButtonModal(true)}>+</button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="clear-btn-container">
                            <button className="clear-btn" onClick={() => clearColumn('pending')}>–û—á–∏—Å—Ç–∏—Ç—å –í—ã–ø–æ–ª–Ω—è–µ–º—ã–µ</button>
                            <button className="clear-btn" onClick={() => clearColumn('completed')}>–û—á–∏—Å—Ç–∏—Ç—å –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
                            <button className="clear-btn" onClick={() => clearColumn('deferred')}>–û—á–∏—Å—Ç–∏—Ç—å –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ</button>
                        </div>
                    </div>
                    <div className="trash-bin" id="trashBin" onDragOver={(e) => { e.preventDefault(); document.getElementById('trashBin').classList.add('dragover'); }} onDrop={dropInTrash} onDragLeave={() => document.getElementById('trashBin').classList.remove('dragover')}>
                        –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                    </div>
                    <div className={`notification ${notification.show ? 'show' : ''}`} id="notification">
                        {notification.message}
                    </div>
                    {showTimerModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä</h3>
                                <div className="time-inputs">
                                    <input
                                        type="number"
                                        value={timerHours}
                                        onChange={(e) => setTimerHours(e.target.value)}
                                        placeholder="–ß–ß"
                                        min="0"
                                        max="23"
                                    />
                                    <span>:</span>
                                    <input
                                        type="number"
                                        value={timerMinutes}
                                        onChange={(e) => setTimerMinutes(e.target.value)}
                                        placeholder="–ú–ú"
                                        min="0"
                                        max="59"
                                    />
                                    <span>:</span>
                                    <input
                                        type="number"
                                        value={timerSeconds}
                                        onChange={(e) => setTimerSeconds(e.target.value)}
                                        placeholder="–°–°"
                                        min="0"
                                        max="59"
                                    />
                                </div>
                                <div className="modal-buttons">
                                    <button onClick={() => submitCustomTime(showTimerModal)}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                    <button onClick={() => setShowTimerModal(null)}>–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showAddButtonModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É</h3>
                                <input
                                    type="number"
                                    className="number-input"
                                    value={newButtonNumber}
                                    onChange={(e) => setNewButtonNumber(e.target.value)}
                                    placeholder="–ù–æ–º–µ—Ä –∫–Ω–æ–ø–∫–∏"
                                    min="1"
                                />
                                <div className="modal-buttons">
                                    <button onClick={addSingleDeferredButton}>–î–æ–±–∞–≤–∏—Ç—å</button>
                                    <button onClick={() => setShowAddButtonModal(false)}>–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
