<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Перетаскивание кнопок - Сакура</title>
    <link rel="icon" href="https://iili.io/3soEozX.png"/>
    <style>
        :root {
            --bg-color: #fff5f7;
            --text-color: #4a2f3b;
            --button-bg: #f8b8c6;
            --button-hover: #ffb6c1;
            --column-bg: rgba(255, 245, 247, 0.9);
            --border-color: #f4c4ce;
            --trash-bg: #ff6b6b;
            --trash-hover: #ff5252;
            --notification-bg: #ff8c94;
            --gradient-light: linear-gradient(145deg, #fff0f5, #ffe4e9);
            --gradient-dark: linear-gradient(145deg, #4a2f3b, #6b4e5a);
            --shadow-light: 5px 5px 15px rgba(244, 196, 206, 0.2), -5px -5px 15px rgba(255, 255, 255, 0.7);
            --shadow-dark: 5px 5px 15px rgba(74, 47, 59, 0.3), -5px -5px 15px rgba(255, 255, 255, 0.05);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            --bg-image: url('https://iili.io/3i4Bo2R.webp');
            background-color: var(--bg-color);
            background-image: var(--bg-image), var(--gradient-light, none);
            background-attachment: fixed;
            background-size: cover, auto;
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.4s ease-in-out;
            margin: 0;
            min-height: 100vh;
            padding-bottom: 0px;
            position: relative;
            overflow-x: hidden;
        }

        .petals {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffb6c1;
            border-radius: 50% 20%;
            opacity: 0.7;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0.7; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0.2; }
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            padding: 15px;
            background: var(--column-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        input {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: var(--shadow-light);
            width: 210px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus {
            outline: 2px solid var(--button-bg);
            box-shadow: 0 0 8px rgba(248, 184, 198, 0.3);
        }

        button {
            position: relative;
            padding: 12px 24px;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        body.dark button {
            color: #fff;
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 0px 10px rgba(248, 184, 198, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 15px;
        }

        .column {
            padding: 20px;
            border-radius: 15px;
            background-color: var(--column-bg);
            box-shadow: var(--shadow-light);
            overflow-y: auto;
            max-height: 600px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            padding-top: 50px;
        }

        .column h2 {
            text-align: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: var(--column-bg);
            z-index: 2;
            padding: 10px;
            font-size: 20px;
        }

        .column.dragover {
            border-color: var(--button-hover);
            transform: scale(1.01);
            background: rgba(248, 184, 198, 0.1);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            min-height: 100px;
        }

        button.pending { background-color: #f8b8c6; }
        button.completed { background-color: #e0d0d5; }
        button.deferred { background-color: #ff8c94; }
        button.dragging { opacity: 0.6; transform: scale(0.95); }

        button .timer-container {
            position: absolute;
            top: 6px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        button .timer {
            font-size: 12px;
            background-color: rgba(74, 47, 59, 0.6);
            padding: 3px 7px;
            border-radius: 8px;
            color: #fff;
        }

        button .edit-time-btn {
            font-size: 12px;
            background-color: #ff8c94;
            border-radius: 6px;
            padding: 2px 6px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button .edit-time-btn:hover {
            background-color: #ff6b6b;
        }

        .timer-control {
            margin: 6px 3px 0;
            font-size: 12px;
            padding: 4px 10px;
            background-color: #4a2f3b;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        .timer-control:hover {
            background-color: #6b4e5a;
        }

        .trash-bin {
            width: 250px;
            height: 50px;
            background-color: var(--trash-bg);
            color: white;
            text-align: center;
            line-height: 50px;
            font-size: 16px;
            border-radius: 10px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .trash-bin:hover,
        .trash-bin.dragover {
            background-color: var(--trash-hover);
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: var(--notification-bg);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            font-size: 16px;
            box-shadow: var(--shadow-light);
        }

        .notification.show {
            display: block;
            animation: fadeInOut 3s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(20px); }
        }

        .clear-btn-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            padding: 15px;
        }

        .clear-btn {
            padding: 12px;
            background-color: var(--trash-bg);
            color: white;
            border: none;
            font-size: 14px;
            border-radius: 10px;
            flex: 1;
            max-width: 200px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background-color: var(--trash-hover);
            transform: translateY(-2px);
        }

        body.dark {
            --bg-color: #2f1b24;
            --text-color: #f4c4ce;
            --button-bg: #e07b8c;
            --button-hover: #f8b8c6;
            --column-bg: rgba(47, 27, 36, 0.9);
            --border-color: #6b4e5a;
            --trash-bg: #c62828;
            --trash-hover: #b71c1c;
            --notification-bg: #ff6b6b;
            --gradient-light: var(--gradient-dark, none);
            --shadow-light: var(--shadow-dark, none);
            --bg-image: url('https://iili.io/3i4BqBa.webp');
        }

        .selected {
            outline: 3px solid #ff8c94;
            background-color: rgba(255, 140, 148, 0.15);
            box-shadow: 0 0 12px rgba(255, 140, 148, 0.5);
            transform: scale(1.02);
        }

        .counter {
            position: absolute;
            top: 10px;
            right: 15px;
            font-weight: bold;
            font-size: 16px;
            color: #fff;
            background-color: var(--button-bg);
            padding: 5px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark .counter {
            background-color: var(--button-bg);
            color: #fff;
        }

        .add-button {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .add-button:hover {
            transform: none;
            background: #fff;
            color: #000;
        }

        .sidebar-toggle {
            position: fixed;
            top: 35px;
            left: 0px;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1100;
            padding: 0;
            transition: left 0.3s ease-in-out;
            border-radius: 0 10px 10px 0;
        }

        .sidebar-toggle.open {
            left: 300px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--column-bg);
            box-shadow: var(--shadow-light);
            padding: 20px;
            z-index: 1050;
            transition: left 0.3s ease-in-out;
            overflow-y: auto;
        }
        .sidebar input {
            width: 100%;    
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chekmarkbox {
            display: flex;
        }

        .chekmarkbox > input {
            width: 16px;
            margin-right: 10px;
        }

        .name-item {
            display: grid;
            grid-template-columns: 60% 30%;
        }

        .name-item > button {
            font-size: 12px;
            padding: 8px 16px;
        }

        .name-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .name-item:last-child {
            border-bottom: none;
        }

        .result-textarea {
            width: 100%;
            height: 100px;
            resize: none;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: var(--shadow-light);
        }

        .login-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--column-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow-light), 0 0 20px rgba(248, 184, 198, 0.3);
            width: 350px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .login-container:hover {
            box-shadow: var(--shadow-light), 0 0 30px rgba(248, 184, 198, 0.5);
        }

        .login-container h2 {
            margin-bottom: 25px;
            font-size: 26px;
            color: var(--text-color);
        }

        .login-container input {
            width: 100%;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
        }

        .login-container button {
            width: 100%;
            background: linear-gradient(145deg, var(--button-bg), var(--button-hover));
            box-shadow: 0 4px 8px rgba(248, 184, 198, 0.3);
        }

        .user-info {
            position: fixed;
            top: 0px;
            right: 0px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--column-bg);
            padding: 10px 15px;
            border-radius: 0 0 0 10px;
            box-shadow: var(--shadow-light);
            z-index: 120;
        }

        .user-info span {
            font-weight: bold;
        }

        .user-info button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--column-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            width: 300px;
            text-align: center;
            border: 1px solid var(--border-color);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--text-color);
        }

        .time-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-inputs input {
            width: 60px;
            padding: 8px;
            text-align: center;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
        }

        .number-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 16px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 15px auto; }
            .controls { flex-direction: column; align-items: center; padding: 10px; }
            input { width: 100%; max-width: 300px; }
            .columns { grid-template-columns: 1fr; gap: 15px; }
            .column { width: 100%; max-height: 500px; }
            .clear-btn { width: 100%; max-width: none; }
            .trash-bin { width: 200px; height: 45px; line-height: 45px; font-size: 14px; right: 10px; bottom: 10px; }
            .notification { bottom: 70px; right: 10px; max-width: 90%; }
            .sidebar { width: 250px; }
            .sidebar.open { left: 0; }
            .sidebar-toggle { width: 40px; height: 40px; font-size: 20px; }
            .login-container { width: 90%; padding: 30px; border-radius: 15px; }
            .user-info { top: 0px; right: 0px; flex-direction: row; gap: 5px; padding: 8px; border-radius: 0 0 0 10px; }
            .modal-content { width: 90%; max-width: 280px; }
            .time-inputs input { width: 50px; font-size: 14px; }
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--column-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border-radius: 10px;
            border: 2px solid var(--column-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--button-hover);
        }

        body.dark ::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border: 2px solid var(--column-bg);
        }

        body.dark ::-webkit-scrollbar-thumb:hover {
            background-color: var(--button-hover);
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            font-size: 16px;
        }

        .tab-button.active {
            background-color: var(--button-hover);
            transform: none;
        }

        .activity-log {
            background: var(--column-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activity-table th, .activity-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .activity-table th {
            background: var(--button-bg);
            color: white;
        }
        select {
            padding: 12px 40px 12px 16px; /* Увеличенный отступ для удобства чтения */
            border: none; /* Убираем стандартную границу для чистого дизайна */
            border-radius: 12px; /* Скругленные углы, как у других элементов */
            font-size: 16px; /* Соответствует шрифтам других элементов */
            font-weight: 500; /* Средний вес для читаемости */
            background: var(--column-bg); /* Фон в стиле колонок для консистентности */
            color: var(--text-color); /* Цвет текста в зависимости от темы */
            width: 100%; /* Полная ширина для удобства на мобильных устройствах */
            cursor: pointer;
            transition: all 0.3s ease; /* Плавные переходы для всех свойств */
            appearance: none; /* Убираем стандартный вид стрелки */
            box-shadow: var(--shadow-light); /* Тень в стиле других элементов */
            position: relative; /* Для позиционирования кастомной стрелки */
        
            /* Кастомная стрелка */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%234a2f3b"><path d="M5.5 7.5l4.5 4.5 4.5-4.5" stroke="%234a2f3b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 16px center; /* Стрелка ближе к краю */
            background-size: 16px; /* Размер стрелки чуть больше для видимости */
        }
        
        select:hover {
            background-color: var(--button-hover); /* Цвет при наведении, как у кнопок */
            box-shadow: 0 0 8px rgba(248, 184, 198, 0.4); /* Усиленная тень при наведении */
            transform: translateY(-1px); /* Легкий подъем, как у кнопок */
        }
        
        select:focus {
            outline: none; /* Убираем стандартный outline */
            box-shadow: 0 0 10px rgba(248, 184, 198, 0.6); /* Яркая тень при фокусе */
            background-color: #fff; /* Чистый белый фон при фокусе */
        }
        
        select:active {
            transform: scale(0.98); /* Эффект нажатия, как у кнопок */
        }
        
        /* Темная тема */
        body.dark select {
            background: linear-gradient(180deg, rgba(60, 35, 45, 0.95) 0%, rgba(45, 25, 35, 0.95) 100%); /* Градиент для темной темы */
            color: var(--text-color); /* Цвет текста для темной темы */
            box-shadow: var(--shadow-dark); /* Тень для темной темы */
            background-image: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%234a2f3b"><path d="M5.5 7.5l4.5 4.5 4.5-4.5" stroke="%234a2f3b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>');
        }
        
        body.dark select:hover {
            background: linear-gradient(180deg, rgba(70, 40, 50, 0.95) 0%, rgba(55, 30, 40, 0.95) 100%); /* Легкое изменение фона при наведении */
            box-shadow: 0 0 8px rgba(244, 196, 206, 0.5); /* Тень для темной темы */
        }
        
        body.dark select:focus {
            background: rgba(70, 40, 50, 0.95); /* Темный фон при фокусе */
            box-shadow: 0 0 10px rgba(244, 196, 206, 0.7); /* Яркая тень */
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            select {
                padding: 10px 35px 10px 14px; /* Меньшие отступы для компактности */
                font-size: 14px; /* Меньший шрифт для мобильных */
                background-size: 14px; /* Уменьшенная стрелка */
                border-radius: 10px; /* Меньший радиус для компактности */
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE_URL = "https://otp-2-fos4.onrender.com";

        const App = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [buttons, setButtons] = useState({ pending: [], completed: [], deferred: [] });
            const [timersRef] = useState(useRef(new Map()));
            const [notification, setNotification] = useState({ show: false, message: '' });
            const [selectedButtons, setSelectedButtons] = useState([]);
            const [fromValue, setFromValue] = useState('');
            const [toValue, setToValue] = useState('');
            const [stepValue, setStepValue] = useState(1);
            const [startButton, setStartButton] = useState('');
            const [result, setResult] = useState('');
            const [activeOperators, setActiveOperators] = useState([]);
            const [isDividing, setIsDividing] = useState(false);
            const [isFetchingOperators, setIsFetchingOperators] = useState(false);
            const [showTimerModal, setShowTimerModal] = useState(null);
            const [timerHours, setTimerHours] = useState('');
            const [timerMinutes, setTimerMinutes] = useState('');
            const [timerSeconds, setTimerSeconds] = useState('');
            const [showAddButtonModal, setShowAddButtonModal] = useState(false);
            const [newButtonNumber, setNewButtonNumber] = useState('');
            const [loggedIn, setLoggedIn] = useState(false);
            const [loginValue, setLoginValue] = useState('');
            const [passwordValue, setPasswordValue] = useState('');
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [userData, setUserData] = useState(null);
            const [isTogglingActive, setIsTogglingActive] = useState(false);
            const [month, setMonth] = useState('');
            const [isGeneratingReport, setIsGeneratingReport] = useState(false);
            const petalsRef = useRef(null);
            const [currentTab, setCurrentTab] = useState('tasks');
            const [activityLogs, setActivityLogs] = useState([]);
            const [showStatusSelect, setShowStatusSelect] = useState(false);
            const [selectedStatus, setSelectedStatus] = useState('');
            const [showStatusModal, setShowStatusModal] = useState(false);
            const [modalStatus, setModalStatus] = useState('');

            useEffect(() => {
                document.body.className = theme === 'dark' ? 'dark' : '';
                localStorage.setItem('theme', theme);
            }, [theme]);

            useEffect(() => {
                const savedApiKey = localStorage.getItem("apiKey");
                const savedUserData = localStorage.getItem("userData");
                if (savedApiKey && savedUserData) {
                    setApiKey(savedApiKey);
                    setUserData(JSON.parse(savedUserData));
                    setLoggedIn(true);
                    fetchActiveOperators(savedApiKey);
                    const parsedUser = JSON.parse(savedUserData);
                    fetchActivityLogs(savedApiKey, parsedUser.id, true);
                }
            }, []);
            
            useEffect(() => {
                const loadButtons = () => {
                    const saved = localStorage.getItem('buttons');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        setButtons(parsed);
                        Object.entries(parsed).forEach(([column, btns]) => {
                            btns.forEach(btn => {
                                const endTime = localStorage.getItem(`timer_${btn.id}`);
                                if (endTime && column === 'deferred') {
                                    const remaining = Math.max(0, parseInt(endTime) - Date.now());
                                    if (remaining > 0) {
                                        startTimer(btn.id, remaining / 1000);
                                    } else {
                                        localStorage.removeItem(`timer_${btn.id}`);
                                        localStorage.removeItem(`restartCount_${btn.id}`);
                                    }
                                }
                            });
                        });
                    }
                };
                loadButtons();
            }, []);

            useEffect(() => {
                localStorage.setItem('buttons', JSON.stringify(buttons));
            }, [buttons]);

            useEffect(() => {
                createPetals();
            }, []);

            useEffect(() => {
              const savedStatus = localStorage.getItem("lastStatus");
              if (savedStatus) setSelectedStatus(savedStatus);
            }, []);

            useEffect(() => {
              if (selectedStatus) localStorage.setItem("lastStatus", selectedStatus);
            }, [selectedStatus]);

            const createPetals = () => {
                const petalsContainer = petalsRef.current;
                if (!petalsContainer) return;
                petalsContainer.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const petal = document.createElement('div');
                    petal.className = 'petal';
                    petal.style.left = `${Math.random() * 100}%`;
                    petal.style.animationDuration = `${Math.random() * 10 + 10}s`;
                    petal.style.animationDelay = `${Math.random() * 5}s`;
                    petalsContainer.appendChild(petal);
                }
            };

            const toggleTheme = () => {
                setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            };

            const toggleSidebar = () => {
                setSidebarOpen(prev => !prev);
            };

            const handleLogin = async () => {
                setIsLoggingIn(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ login: loginValue, password: passwordValue })
                    });
                    const data = await res.json();
                    if (res.ok && data.status === 'success') {
                        const user = { id: data.id, name: data.name, role: data.role, isActive: false };
                        setApiKey(data.apiKey);
                        setUserData(user);
                        setLoggedIn(true);
                        showNotification('Вход успешен!');
                        localStorage.setItem("apiKey", data.apiKey);
                        localStorage.setItem("userData", JSON.stringify(user));
                        fetchActiveOperators(data.apiKey);
                        await fetchActivityLogs(data.apiKey, data.id, true);
                    } else {
                        showNotification(data.error || 'Ошибка входа');
                    }
                } catch (err) {
                    showNotification('Ошибка сети');
                }
                setIsLoggingIn(false);
            };

            const fetchUserProfile = async (userId) => {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/user/profile?user_id=${userId}`, {
                        headers: { 'X-API-Key': apiKey }
                    });
                    const data = await res.json();
                    if (res.ok && data.status === 'success') {
                        setUserData(prev => ({ ...prev, isActive: data.profile.is_active }));
                    }
                } catch (err) {
                    console.error('Error fetching profile:', err);
                }
            };

            const handleLogout = () => {
                setLoggedIn(false);
                setUserData(null);
                setApiKey('');
                localStorage.removeItem("apiKey");
                localStorage.removeItem("userData");
                showNotification('Вы вышли из аккаунта');
            };

            const toggleActive = async (newStatus) => {
                setIsTogglingActive(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/user/toggle_active`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-API-Key': apiKey,
                            'X-User-Id': userData.id
                        },
                        body: JSON.stringify({ status: newStatus })
                    });
                    const data = await res.json();
                    if (res.ok && (data.status === 'success' || data.status === 'unchanged')) {
                        // Устанавливаем isActive в false для всех статусов, кроме 'active'
                        setUserData(prev => ({ ...prev, isActive: newStatus === 'active' }));
                        showNotification(`Статус: ${newStatus}`);
                    } else {
                        showNotification(data.error || 'Ошибка');
                    }
                } catch (err) {
                    showNotification('Ошибка сети');
                }
                setIsTogglingActive(false);
                setShowStatusSelect(false); // Закрываем select после выбора
            };

            const fetchActiveOperators = async (key) => {
                setIsFetchingOperators(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/active_operators`, {
                        headers: { 'X-API-Key': key }
                    });
                    const data = await res.json();
                    if (res.ok && data.status === 'success') {
                        setActiveOperators(data.operators);
                    } else {
                        showNotification(data.error || 'Ошибка загрузки операторов');
                    }
                } catch (err) {
                    showNotification('Ошибка сети');
                }
                setIsFetchingOperators(false);
            };

            const generateReport = async () => {
                setIsGeneratingReport(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/report/monthly?month=${month}`, {
                        headers: { 
                            'X-API-Key': apiKey,
                            'X-User-Id': userData.id
                        }
                    });
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report_${month}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        showNotification('Отчет скачан!');
                    } else {
                        const data = await res.json();
                        showNotification(data.error || 'Ошибка генерации отчета');
                    }
                } catch (err) {
                    showNotification('Ошибка сети');
                }
                setIsGeneratingReport(false);
            };

            const fetchActivityLogs = async (key = apiKey, userId = userData?.id, updateStatus = false) => {
              try {
                const today = new Date().toISOString().split('T')[0];
                const res = await fetch(`${API_BASE_URL}/api/user/activity_logs?date=${today}`, {
                  headers: { 
                    'X-API-Key': key,
                    'X-User-Id': userId
                  }
                });
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                  setActivityLogs(data.logs);
            
                  // === обновляем статус при входе ===
                  if (updateStatus && data.logs.length > 0) {
                    const lastLog = data.logs[data.logs.length - 1];
                    setSelectedStatus(lastLog.is_active);
                    localStorage.setItem("lastStatus", lastLog.is_active);
                  }
                } else {
                  showNotification(data.error || 'Ошибка загрузки логов');
                }
              } catch (err) {
                showNotification('Ошибка сети');
              }
            };

            useEffect(() => {
                if (currentTab === 'activity' && userData.role === 'operator') {
                    fetchActivityLogs();
                }
            }, [currentTab]);

            const formatDuration = (ms) => {
                if (ms <= 0) return '0s';
                const seconds = Math.floor((ms / 1000) % 60);
                const minutes = Math.floor((ms / 1000 / 60) % 60);
                const hours = Math.floor(ms / 1000 / 3600);
                return `${hours > 0 ? hours + 'h ' : ''}${minutes > 0 ? minutes + 'm ' : ''}${seconds}s`;
            };

            const computeActivity = () => {
                if (!activityLogs.length) return [];
                const now = new Date();
                const computed = [];
                for (let i = 0; i < activityLogs.length; i++) {
                    const log = activityLogs[i];
                    const changeTime = new Date(log.change_time);
                    const nextTime = i < activityLogs.length - 1 ? new Date(activityLogs[i + 1].change_time) : now;
                    const duration = nextTime - changeTime;
                    computed.push({
                        time: changeTime.toLocaleTimeString(),
                        status: log.is_active,
                        duration: formatDuration(duration)
                    });
                }
                return computed;
            };

            const addButtons = () => {
                const from = parseInt(fromValue);
                const to = parseInt(toValue);
                const step = parseInt(stepValue) || 1;
                if (isNaN(from) || isNaN(to) || from > to) {
                    showNotification('Некорректные значения!');
                    return;
                }
                const newBtns = [];
                for (let i = from; i <= to; i += step) {
                    newBtns.push({ id: `${Date.now()}-${i}`, num: i });
                }
                setButtons(prev => ({ ...prev, pending: [...prev.pending, ...newBtns] }));
                showNotification('Кнопки добавлены!');
            };

            const addSingleDeferredButton = () => {
                const num = parseInt(newButtonNumber);
                if (isNaN(num) || num < 1) {
                    showNotification('Введите корректный номер!');
                    return;
                }
                const exists = Object.values(buttons).flat().some(b => b.num === num);
                if (exists) {
                    showNotification('Кнопка с таким номером уже существует!');
                    return;
                }
                const newBtn = { id: `${Date.now()}-${num}`, num };
                setButtons(prev => ({ ...prev, deferred: [...prev.deferred, newBtn] }));
                
                // Запускаем таймер сразу (15 минут = 900 сек)
                startTimer(newBtn.id, 900);
            
                showNotification('Кнопка добавлена в Отложенные!');
                setShowAddButtonModal(false);
                setNewButtonNumber('');
            };


            const showNotification = (msg) => {
                setNotification({ show: true, message: msg });
                setTimeout(() => setNotification({ show: false, message: '' }), 3000);
            };

            const startTimer = (id, duration) => {
                const endTime = Date.now() + duration * 1000;
                localStorage.setItem(`timer_${id}`, endTime);
                updateTimerDisplay(id, duration);
            
                const interval = setInterval(() => {
                    const remaining = Math.max(0, endTime - Date.now());
                    updateTimerDisplay(id, remaining / 1000);
            
                    if (remaining <= 0) {
                        clearInterval(interval);
                        timersRef.current.delete(id);
                        localStorage.removeItem(`timer_${id}`);
            
                        // === Уведомление при завершении таймера ===
                        if ("Notification" in window) {
                            if (Notification.permission === "granted") {
                                new Notification("⏰ Таймер завершен!", {
                                    body: "Задача " + id.split("-")[1] + " закончила отсчет.",
                                    icon: "https://iili.io/3soEozX.png" // иконка (можно заменить)
                                });
                            } else if (Notification.permission !== "denied") {
                                // Запросить разрешение и потом показать
                                Notification.requestPermission().then(permission => {
                                    if (permission === "granted") {
                                        new Notification("⏰ Таймер завершен!", {
                                            body: "Задача " + id.split("-")[1] + " закончила отсчет.",
                                            icon: "https://iili.io/3soEozX.png"
                                        });
                                    } else {
                                        showNotification("⏰ Таймер завершен!");
                                    }
                                });
                            } else {
                                showNotification("⏰ Таймер завершен!");
                            }
                        } else {
                            showNotification("⏰ Таймер завершен!");
                        }
                        setButtons(prev => ({ ...prev }));
                    }
                }, 1000);
            
                timersRef.current.set(id, interval);
            };

            const updateTimerDisplay = (id, seconds) => {
                const timerEl = document.getElementById(`timer-${id}`);
                if (timerEl) {
                    const hrs = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    timerEl.textContent = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            };

            const promptForCustomTime = (id) => {
                setShowTimerModal(id);
            };

            const submitCustomTime = (id) => {
                const hours = parseInt(timerHours) || 0;
                const minutes = parseInt(timerMinutes) || 0;
                const seconds = parseInt(timerSeconds) || 0;
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                if (totalSeconds <= 0) {
                    showNotification('Введите корректное время!');
                    return;
                }
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                startTimer(id, totalSeconds);
                setShowTimerModal(null);
                setTimerHours('');
                setTimerMinutes('');
                setTimerSeconds('');
            };

            const restartTimer = (id) => {
                let restartCount = parseInt(localStorage.getItem(`restartCount_${id}`) || '0');
                restartCount++;
                localStorage.setItem(`restartCount_${id}`, restartCount);
                const duration = restartCount === 1 ? 1800 : 3600;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                startTimer(id, duration);
                setButtons(prev => ({ ...prev }));
            };

            const completeTask = (id, column) => {
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                setButtons(prev => {
                    const btn = prev.deferred.find(b => b.id === id);
                    if (!btn) return prev;
                    return {
                        ...prev,
                        deferred: prev.deferred.filter(b => b.id !== id),
                        completed: [...prev.completed, btn]
                    };
                });
            };

            const handleButtonClick = (e, btn, column) => {
                if (e.ctrlKey || e.metaKey) {
                    setSelectedButtons(prev => prev.some(s => s.id === btn.id) ? prev.filter(s => s.id !== btn.id) : [...prev, {...btn, column}]);
                } else {
                    setSelectedButtons([{...btn, column}]);
                }
            };

            const openSelectedInTabs = () => {
                if (selectedButtons.length === 0) return showNotification('Выберите кнопку!');
                selectedButtons.forEach(btn => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank'));
            };

            const deleteButton = (btn) => {
                if (!confirm('Уверены?')) return;
                const id = btn.id;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                timersRef.current.delete(id);
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    Object.keys(newButtons).forEach(col => {
                        newButtons[col] = newButtons[col].filter(b => b.id !== id);
                    });
                    return newButtons;
                });
                setSelectedButtons(prev => prev.filter(s => s.id !== id));
                showNotification('Кнопка удалена!');
            };

            const dragStart = (e, btn) => {
                e.dataTransfer.setData('text/plain', JSON.stringify(btn));
                e.target.classList.add('dragging');
            };

            const dragEnd = (e) => {
                e.target.classList.remove('dragging');
            };

            const allowDrop = (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            };

            const drop = (e, targetColumn) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                setSelectedButtons([]);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    selectedButtons.forEach(selBtn => {
                        Object.keys(newButtons).forEach(col => {
                            newButtons[col] = newButtons[col].filter(b => b.id !== selBtn.id);
                        });
                        newButtons[targetColumn].push(selBtn);
                        if (targetColumn === 'deferred') {
                            startTimer(selBtn.id, 900);
                        } else if (selBtn.column === 'deferred') {
                            if (timersRef.current.has(selBtn.id)) clearInterval(timersRef.current.get(selBtn.id));
                            timersRef.current.delete(selBtn.id);
                            localStorage.removeItem(`timer_${selBtn.id}`);
                            localStorage.removeItem(`restartCount_${selBtn.id}`);
                        }
                    });
                    return newButtons;
                });
            };

            const dropInTrash = (e) => {
                e.preventDefault();
                document.getElementById('trashBin').classList.remove('dragover');
                selectedButtons.forEach(selBtn => deleteButton(selBtn));
            };

            const clearColumn = (columnId) => {
                buttons[columnId].forEach(btn => {
                    if (timersRef.current.has(btn.id)) clearInterval(timersRef.current.get(btn.id));
                    timersRef.current.delete(btn.id);
                    localStorage.removeItem(`timer_${btn.id}`);
                    localStorage.removeItem(`restartCount_${btn.id}`);
                });
                setButtons(prev => ({ ...prev, [columnId]: [] }));
                showNotification(`Колонка "${columnId}" очищена!`);
            };

            const divideButtons = async () => {
                setIsDividing(true);
                await fetchActiveOperators(apiKey);
                const start = parseInt(startButton);
                if (isNaN(start) || start < 1) {
                    showNotification('Введите корректный номер!');
                    setIsDividing(false);
                    return;
                }
                if (activeOperators.length === 0) {
                    showNotification('Нет активных операторов!');
                    setIsDividing(false);
                    return;
                }
                const res = activeOperators.map((op, index) => `${start + index} - ${op.name.split(' ')[1]}`).join('\n');
                setResult(res);
                showNotification('Тикеты поделены!');
                setIsDividing(false);
            };

            const copyResult = () => {
                navigator.clipboard.writeText(result);
                showNotification('Текст скопирован!');
            };

            const renderButton = (btn, column) => {
                const id = btn.id;
                const endTime = localStorage.getItem(`timer_${id}`);
                const hasTimer = column === 'deferred' && endTime && (parseInt(endTime) > Date.now());
                const showControls = column === 'deferred' && !hasTimer;
                const isSelected = selectedButtons.some(s => s.id === id);
                return (
                    <button
                        key={id}
                        id={id}
                        className={`${column} ${isSelected ? 'selected' : ''}`}
                        draggable
                        onDragStart={(e) => dragStart(e, btn)}
                        onDragEnd={dragEnd}
                        onClick={(e) => handleButtonClick(e, btn, column)}
                        onDoubleClick={() => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank')}
                        onContextMenu={(e) => { e.preventDefault(); deleteButton(btn); }}
                    >
                        Кнопка {btn.num}
                        {column === 'deferred' && (
                            <div className="timer-container">
                                {hasTimer && (
                                    <>
                                        <div className="timer" id={`timer-${id}`}></div>
                                        <button className="edit-time-btn" onClick={() => promptForCustomTime(id)}>🖋️</button>
                                    </>
                                )}
                            </div>
                        )}
                        {showControls && (
                            <>
                                <button className="timer-control" onClick={() => restartTimer(id)}>↻</button>
                                <button className="timer-control" onClick={() => completeTask(id, column)}>✔</button>
                            </>
                        )}
                    </button>
                );
            };

            const renderActivityTab = () => {
              const computedActivity = computeActivity();
            
              // === считаем отрезки для таймлайна ===
              const now = new Date();
              const startOfDay = new Date();
              startOfDay.setHours(0, 0, 0, 0);
            
              const segments = activityLogs.map((log, i) => {
                const start = new Date(log.change_time);
                const end = i < activityLogs.length - 1 ? new Date(activityLogs[i + 1].change_time) : now;
                const durationMs = end - start;
            
                return {
                  status: log.is_active,
                  start,
                  end,
                  durationMs,
                  duration: formatDuration(durationMs),
                  percentStart: ((start - startOfDay) / (24 * 3600 * 1000)) * 100,
                  percentWidth: ((durationMs) / (24 * 3600 * 1000)) * 100
                };
              });
            
              // === суммарное время по каждому статусу ===
              const totals = segments.reduce((acc, seg) => {
                acc[seg.status] = (acc[seg.status] || 0) + seg.durationMs;
                return acc;
              }, {});
            
              const statusColors = {
                active: "#4caf50",
                break: "#ff9800",
                tech: "#9c27b0",
                training: "#2196f3",
                inactive: "#f44336"
              };
            
              return (
                <div className="activity-log">
                  <h2>Активность за сегодня</h2>
            
                  {/* === Таймлайн === */}
                  <div style={{ position: "relative", height: "30px", background: "#eee", marginBottom: "10px" }}>
                    {segments.map((seg, idx) => (
                      <div
                        key={idx}
                        title={`${seg.status} — ${seg.duration}`}
                        style={{
                          position: "absolute",
                          left: `${seg.percentStart}%`,
                          width: `${seg.percentWidth}%`,
                          height: "100%",
                          background: statusColors[seg.status] || "#999"
                        }}
                      />
                    ))}
                  </div>
            
                  {/* === Подписи времени === */}
                  <div style={{ display: "flex", justifyContent: "space-between", fontSize: "12px", color: "#666", marginBottom: "20px" }}>
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>24:00</span>
                  </div>
            
                  {/* === Суммарное время по статусам === */}
                <div style={{ marginBottom: "20px" }}>
                  <h3>Сводка по статусам</h3>
                  <ul style={{ listStyle: "none", padding: 0 }}>
                    {Object.entries(totals).map(([status, ms]) => {
                      let label = status;
                
                      if (status === "active") label = "Активен";
                      if (status === "break") label = "Перерыв";
                      if (status === "tech") label = "Тех. причина";
                      if (status === "training") label = "Тренинг";
                
                      // === особая обработка для inactive ===
                      if (status === "inactive") {
                          const inactiveLog = activityLogs.find(l => l.is_active === "inactive");
                          if (inactiveLog) {
                            const date = new Date(inactiveLog.change_time);
                            const hours = date.getHours().toString().padStart(2, "0");
                            const minutes = date.getMinutes().toString().padStart(2, "0");
                            label = `Смена завершена в ${hours}:${minutes}`;
                          } else {
                            label = "Смена завершена";
                          }
                        }
                
                      return (
                        <li key={status} style={{ margin: "4px 0" }}>
                          <span
                            style={{
                              display: "inline-block",
                              width: "12px",
                              height: "12px",
                              background: statusColors[status] || "#999",
                              marginRight: "8px"
                            }}
                          ></span>
                          {label}: {status !== "inactive" ? formatDuration(ms) : ""}
                        </li>
                      );
                    })}
                  </ul>
                </div>

            
                  {/* === Таблица логов === */}
                  {computedActivity.length > 0 ? (
                    <table className="activity-table">
                      <thead>
                        <tr>
                          <th>Время</th>
                          <th>Статус</th>
                          <th>Длительность</th>
                        </tr>
                      </thead>
                      <tbody>
                        {computedActivity.slice().reverse().map((entry, index) => (
                          <tr key={index}>
                            <td>{entry.time}</td>
                            <td>{entry.status}</td>
                            <td>{entry.duration}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  ) : (
                    <p>Нет записей за сегодня</p>
                  )}
                </div>
              );
            };

            if (!loggedIn) {
                return (
                    <div className="login-container">
                        <h2>Вход в аккаунт</h2>
                        <input type="text" value={loginValue} onChange={(e) => setLoginValue(e.target.value)} placeholder="Логин" />
                        <input type="password" value={passwordValue} onChange={(e) => setPasswordValue(e.target.value)} placeholder="Пароль" />
                        <button onClick={handleLogin} disabled={isLoggingIn}>
                            {isLoggingIn ? <div className="loader"></div> : 'Войти'}
                        </button>
                        <div className={`notification ${notification.show ? 'show' : ''}`}>{notification.message}</div>
                    </div>
                );
            }

            return (
                <>
                    <div className="petals" ref={petalsRef}></div>
                    <button className={`sidebar-toggle ${sidebarOpen ? 'open' : ''}`} onClick={toggleSidebar} aria-label="Открыть меню разделения кнопок">📝</button>
                    <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-content">
                            {userData.role === 'operator' && (
                              <>
                                {!selectedStatus || selectedStatus === "inactive" ? (
                                  <button 
                                    onClick={() => { setSelectedStatus("active"); toggleActive("active"); }} 
                                    disabled={isTogglingActive}
                                  >
                                    {isTogglingActive ? <div className="loader"></div> : "Начать смену"}
                                  </button>
                                ) : selectedStatus === "active" ? (
                                  <button onClick={() =>{setModalStatus(selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                                    {isTogglingActive ? <div className="loader"></div> : "Вы активны"}
                                  </button>
                                ) : selectedStatus === "break" ? (
                                  <button onClick={() =>{setModalStatus(selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                                    {isTogglingActive ? <div className="loader"></div> : "Не активен: Перерыв"}
                                  </button>
                                ) : selectedStatus === "training" ? (
                                  <button onClick={() =>{setModalStatus(selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                                    {isTogglingActive ? <div className="loader"></div> : "Не активен: Тренинг"}
                                  </button>
                                ) : selectedStatus === "tech" ? (
                                  <button onClick={() =>{setModalStatus(selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                                    {isTogglingActive ? <div className="loader"></div> : "Не активен: Тех. причина"}
                                  </button>
                                ) : null}
                              </>
                            )}
                            <input type="number" value={startButton} onChange={(e) => setStartButton(e.target.value)} placeholder="Начальный номер тикета" />
                            <button onClick={divideButtons} disabled={isDividing || isFetchingOperators}>
                                {isDividing || isFetchingOperators ? <div className="loader"></div> : 'Поделить'}
                            </button>
                            <textarea className="result-textarea" value={result} readOnly />
                            <button onClick={copyResult}>Скопировать</button>
                            {userData.role !== 'operator' && (
                                <>
                                    <input 
                                        type="month" 
                                        value={month} 
                                        onChange={(e) => setMonth(e.target.value)} 
                                        placeholder="Месяц YYYY-MM" 
                                    />
                                    <button onClick={generateReport} disabled={isGeneratingReport}>
                                        {isGeneratingReport ? <div className="loader"></div> : 'Отчет'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    {userData && (
                        <div className="user-info">
                            <span>{userData.name}</span>
                            <button onClick={handleLogout}>Выйти</button>
                        </div>
                    )}
                    <div className="tabs">
                        <button 
                            className={`tab-button ${currentTab === 'tasks' ? 'active' : ''}`} 
                            onClick={() => setCurrentTab('tasks')}
                        >
                            Задачи
                        </button>
                        {userData.role === 'operator' && (
                            <button 
                                className={`tab-button ${currentTab === 'activity' ? 'active' : ''}`} 
                                onClick={() => setCurrentTab('activity')}
                            >
                                Активность
                            </button>
                        )}
                    </div>
                    <div className="container">
                        {currentTab === 'tasks' ? (
                            <>
                                <div className="controls">
                                    <button onClick={toggleTheme} aria-label="Переключить тему">
                                        <span>{theme === 'dark' ? '☀️' : '🌙'}</span>
                                    </button>
                                    <input type="number" value={fromValue} onChange={(e) => setFromValue(e.target.value)} placeholder="С какой кнопки" />
                                    <input type="number" value={toValue} onChange={(e) => setToValue(e.target.value)} placeholder="До какой кнопки" />
                                    <input type="number" value={stepValue} onChange={(e) => setStepValue(e.target.value)} placeholder="Шаг" />
                                    <button onClick={addButtons} aria-label="Добавить кнопки">Добавить кнопки</button>
                                    <button onClick={openSelectedInTabs} aria-label="Открыть выбранные">Открыть выбранные</button>
                                </div>
                                <div className="columns">
                                    {['pending', 'completed', 'deferred'].map(column => (
                                        <div
                                            key={column}
                                            className="column"
                                            id={column}
                                            onDrop={(e) => drop(e, column)}
                                            onDragOver={allowDrop}
                                            onDragLeave={(e) => e.currentTarget.classList.remove('dragover')}
                                        >
                                            <h2>{column === 'pending' ? 'Выполняемые' : column === 'completed' ? 'Выполненные' : 'Отложенные'}</h2>
                                            <div className="list" id={`${column}List`}>
                                                {buttons[column].map(btn => renderButton(btn, column))}
                                            </div>
                                            <div className="counter" id={`${column}Count`}>
                                                {buttons[column].length}
                                                {column === 'deferred' && (
                                                    <button className="add-button" onClick={() => setShowAddButtonModal(true)}>+</button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="clear-btn-container">
                                    <button className="clear-btn" onClick={() => clearColumn('pending')}>Очистить Выполняемые</button>
                                    <button className="clear-btn" onClick={() => clearColumn('completed')}>Очистить Выполненные</button>
                                    <button className="clear-btn" onClick={() => clearColumn('deferred')}>Очистить Отложенные</button>
                                </div>
                            </>
                        ) : (
                            renderActivityTab()
                        )}
                    </div>
                    <div className="trash-bin" id="trashBin" onDragOver={(e) => { e.preventDefault(); document.getElementById('trashBin').classList.add('dragover'); }} onDrop={dropInTrash} onDragLeave={() => document.getElementById('trashBin').classList.remove('dragover')}>
                        Перетащите сюда для удаления
                    </div>
                    <div className={`notification ${notification.show ? 'show' : ''}`} id="notification">
                        {notification.message}
                    </div>
                    {showTimerModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <h3>Установить таймер</h3>
                                <div className="time-inputs">
                                    <input
                                        type="number"
                                        value={timerHours}
                                        onChange={(e) => setTimerHours(e.target.value)}
                                        placeholder="ЧЧ"
                                        min="0"
                                        max="23"
                                    />
                                    <span>:</span>
                                    <input
                                        type="number"
                                        value={timerMinutes}
                                        onChange={(e) => setTimerMinutes(e.target.value)}
                                        placeholder="ММ"
                                        min="0"
                                        max="59"
                                    />
                                    <span>:</span>
                                    <input
                                        type="number"
                                        value={timerSeconds}
                                        onChange={(e) => setTimerSeconds(e.target.value)}
                                        placeholder="СС"
                                        min="0"
                                        max="59"
                                    />
                                </div>
                                <div className="modal-buttons">
                                    <button onClick={() => submitCustomTime(showTimerModal)}>Сохранить</button>
                                    <button onClick={() => setShowTimerModal(null)}>Отмена</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showAddButtonModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <h3>Добавить кнопку</h3>
                                <input
                                    type="number"
                                    className="number-input"
                                    value={newButtonNumber}
                                    onChange={(e) => setNewButtonNumber(e.target.value)}
                                    placeholder="Номер кнопки"
                                    min="1"
                                />
                                <div className="modal-buttons">
                                    <button onClick={addSingleDeferredButton}>Добавить</button>
                                    <button onClick={() => setShowAddButtonModal(false)}>Отмена</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showStatusModal && (
                      <div className="modal">
                        <div className="modal-content">
                          <h3>Выбор статуса</h3>
                          <select
                            value={modalStatus}
                            onChange={(e) => setModalStatus(e.target.value)}
                          >
                            {selectedStatus !== "active" && (
                              <option value="active">Подключиться</option>
                            )}
                            <option value="break">Перерыв</option>
                            <option value="tech">Тех. причина</option>
                            <option value="training">Тренинг</option>
                            <option value="inactive">Завершить смену</option>
                          </select>
                          <div className="modal-buttons">
                            <button
                              onClick={() => {
                                setSelectedStatus(modalStatus);
                                toggleActive(modalStatus);
                                setShowStatusModal(false);
                              }}
                            >
                              Сохранить
                            </button>
                            <button onClick={() => setShowStatusModal(false)}>Отмена</button>
                          </div>
                        </div>
                      </div>
                    )}
                </>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
