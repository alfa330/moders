<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–¥–µ—Ä–∫–∞ - –°–∞–∫—É—Ä–∞</title>
    <link rel="icon" href="https://iili.io/3soEozX.png"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        :root {
            --bg-color: #fff5f7;
            --text-color: #4a2f3b;
            --button-bg: #f8b8c6;
            --button-hover: #ffb6c1;
            --column-bg: rgba(255, 245, 247, 0.9);
            --border-color: #f4c4ce;
            --trash-bg: #ff6b6b;
            --trash-hover: #ff5252;
            --notification-bg: #ff8c94;
            --gradient-light: linear-gradient(145deg, #fff0f5, #ffe4e9);
            --gradient-dark: linear-gradient(145deg, #4a2f3b, #6b4e5a);
            --shadow-light: 5px 5px 15px rgba(244, 196, 206, 0.2), -5px -5px 15px rgba(255, 255, 255, 0.7);
            --shadow-dark: 5px 5px 15px rgba(74, 47, 59, 0.3), -5px -5px 15px rgba(255, 255, 255, 0.05);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            --bg-image: url('https://iili.io/3i4Bo2R.webp');
            background-color: var(--bg-color);
            background-image: var(--bg-image), var(--gradient-light, none);
            background-attachment: fixed;
            background-size: cover, auto;
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.4s ease-in-out;
            margin: 0;
            min-height: 100vh;
            padding-bottom: 0px;
            position: relative;
            overflow-x: hidden;
        }

        .petals {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffb6c1;
            border-radius: 50% 20%;
            opacity: 0.7;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0.7; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0.2; }
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 14px;
            border-radius: 22px;
            box-shadow: 0 2px 8px rgba(244, 196, 206, 0.10);
            border: 0px solid var(--border-color);
            background: var(--column-bg);
            min-height: unset;
            margin-top: 14px;
            margin-bottom: -16px;
            width: 100%;
            max-width: 570px;
            margin-left: 13px;
        }

        .controls button,
        .controls input {
            height: 40px;
            min-width: 40px;
            font-size: 15px;
            border-radius: 10px;
            box-shadow: none;
            margin: 0;
        }

        .theme-toggle-btn {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-right: 4px;
            background: var(--button-bg);
            transition: background 0.2s;
        }

        .theme-toggle-btn:hover {
            background: var(--button-hover);
        }


        .controls input[type="number"] {
            width: 120px;
            padding: 0 12px;
            font-size: 15px;
        }

        input {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: var(--shadow-light);
            width: 210px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus {
            outline: 2px solid var(--button-bg);
            box-shadow: 0 0 8px rgba(248, 184, 198, 0.3);
        }

        button {
            position: relative;
            padding: 12px 24px;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        button .restart-badge {
            position: absolute;
            top: 6px;
            left: 10px;
            background-color: rgba(74, 47, 59, 0.6);
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            padding: 3px 7px;
            border-radius: 8px;
            min-width: 20px;
            text-align: center;
        }

        body.dark button {
            color: #fff;
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 0px 10px rgba(248, 184, 198, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 15px;
        }

        .column {
            padding: 20px;
            border-radius: 15px;
            background-color: var(--column-bg);
            box-shadow: var(--shadow-light);
            overflow-y: auto;
            max-height: 600px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            padding-top: 50px;
        }

        .column h2 {
            text-align: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: var(--column-bg);
            z-index: 2;
            padding: 10px;
            font-size: 20px;
        }

        .column.dragover {
            border-color: var(--button-hover);
            transform: scale(1.01);
            background: rgba(248, 184, 198, 0.1);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            min-height: 100px;
        }

        button.pending { background-color: #f8b8c6; }
        button.completed { background-color: #e0d0d5; }
        button.deferred { background-color: #ff8c94; }
        button.dragging { opacity: 0.6; transform: scale(0.95); }

        button .timer-container {
            position: absolute;
            top: 6px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        button .timer {
            font-size: 12px;
            background-color: rgba(74, 47, 59, 0.6);
            padding: 3px 7px;
            border-radius: 8px;
            color: #fff;
        }

        button .edit-time-btn {
            font-size: 12px;
            background-color: #ff8c94;
            border-radius: 6px;
            padding: 2px 6px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .small-btn {
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 8px;
            background: var(--button-bg);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        .small-btn:hover { transform: translateY(-2px); }
        .small-btn:active { transform: scale(0.98); }
        .small-btn.active {
            background: var(--button-hover);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        /* —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ textarea –≤ –º–æ–¥–∞–ª–∫–µ */
        .modal-content .result-textarea {
            height: 120px;
            font-size: 14px;
            padding: 8px;
        }

        button .edit-time-btn:hover {
            background-color: #ff6b6b;
        }

        .timer-control {
            margin: 6px 3px 0;
            font-size: 12px;
            padding: 4px 10px;
            background-color: #4a2f3b;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        .timer-control:hover {
            background-color: #6b4e5a;
        }

        .status-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--column-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }
        
        .status-selector h3 {
            margin: 0;
            font-size: 16px;
            color: var(--text-color);
        }

        .notification {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: var(--notification-bg);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            font-size: 16px;
            box-shadow: var(--shadow-light);
        }

        .notification.show {
            display: block;
            animation: fadeInOut 3s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(20px); }
        }

        .clear-btn-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            padding: 15px;
        }

        .clear-btn {
            padding: 12px;
            background-color: var(--trash-bg);
            color: white;
            border: none;
            font-size: 14px;
            border-radius: 10px;
            flex: 1;
            max-width: 200px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background-color: var(--trash-hover);
            transform: translateY(-2px);
        }

        body.dark {
            --bg-color: #2f1b24;
            --text-color: #f4c4ce;
            --button-bg: #e07b8c;
            --button-hover: #f8b8c6;
            --column-bg: rgba(47, 27, 36, 0.9);
            --border-color: #6b4e5a;
            --trash-bg: #c62828;
            --trash-hover: #b71c1c;
            --notification-bg: #ff6b6b;
            --gradient-light: var(--gradient-dark, none);
            --shadow-light: var(--shadow-dark, none);
            --bg-image: url('https://iili.io/3i4BqBa.webp');
        }

        .selected {
            outline: 3px solid #ff8c94;
            background-color: rgba(255, 140, 148, 0.15);
            box-shadow: 0 0 12px rgba(255, 140, 148, 0.5);
            transform: scale(1.02);
        }

        .counter {
            position: absolute;
            top: 10px;
            right: 15px;
            font-weight: bold;
            font-size: 16px;
            color: #fff;
            background-color: var(--button-bg);
            padding: 5px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark .counter {
            background-color: var(--button-bg);
            color: #fff;
        }

        .add-button {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
        }

        .add-button:hover {
            transform: none;
            background: #fff;
            color: #000;
        }

        .sidebar-toggle {
            position: fixed;
            top: 35px;
            left: 0px;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1100;
            padding: 0;
            transition: left 0.3s ease-in-out;
            border-radius: 0 10px 10px 0;
        }

        .sidebar-toggle.open {
            left: 300px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--column-bg);
            box-shadow: var(--shadow-light);
            padding: 20px;
            z-index: 1050;
            transition: left 0.3s ease-in-out;
            overflow-y: auto;
        }
        .sidebar input {
            width: 100%;    
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chekmarkbox {
            display: flex;
        }

        .chekmarkbox > input {
            width: 16px;
            margin-right: 10px;
        }

        .name-item {
            display: grid;
            grid-template-columns: 60% 30%;
        }

        .name-item > button {
            font-size: 12px;
            padding: 8px 16px;
        }

        .name-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .name-item:last-child {
            border-bottom: none;
        }

        .result-textarea {
            width: 100%;
            height: 100px;
            resize: none;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: var(--shadow-light);
        }

        .login-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--column-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow-light), 0 0 20px rgba(248, 184, 198, 0.3);
            width: 350px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .login-container:hover {
            box-shadow: var(--shadow-light), 0 0 30px rgba(248, 184, 198, 0.5);
        }

        .login-container h2 {
            margin-bottom: 25px;
            font-size: 26px;
            color: var(--text-color);
        }

        .login-container input {
            width: 100%;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border-color);
        }

        .login-container button {
            width: 100%;
            background: linear-gradient(145deg, var(--button-bg), var(--button-hover));
            box-shadow: 0 4px 8px rgba(248, 184, 198, 0.3);
        }

        .user-info {
            position: fixed;
            top: 0px;
            right: 0px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--column-bg);
            padding: 10px 15px;
            border-radius: 0 0 0 10px;
            box-shadow: var(--shadow-light);
            z-index: 120;
        }

        .user-info span {
            font-weight: bold;
        }

        .user-info button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--column-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            width: 300px;
            text-align: center;
            border: 1px solid var(--border-color);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: var(--text-color);
        }

        .time-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-inputs input {
            width: 60px;
            padding: 8px;
            text-align: center;
            font-size: 16px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
        }

        .number-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 16px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 15px auto; }
            .controls { flex-direction: column; padding: 8px 4px; max-width: 100%; }
            input { width: 100%; max-width: 300px; }
            .columns { grid-template-columns: 1fr; gap: 15px; }
            .column { width: 100%; max-height: 500px; }
            .clear-btn { width: 100%; max-width: none; }
            .trash-bin { width: 200px; height: 45px; line-height: 45px; font-size: 14px; right: 10px; bottom: 10px; }
            .notification { bottom: 70px; right: 10px; max-width: 90%; }
            .sidebar { width: 250px; }
            .sidebar.open { left: 0; }
            .sidebar-toggle { width: 40px; height: 40px; font-size: 20px; }
            .login-container { width: 90%; padding: 30px; border-radius: 15px; }
            .user-info { top: 0px; right: 0px; flex-direction: row; gap: 5px; padding: 8px; border-radius: 0 0 0 10px; }
            .modal-content { width: 90%; max-width: 280px; }
            .time-inputs input { width: 50px; font-size: 14px; }
            .theme-toggle-btn { margin-right: 0; margin-bottom: 4px;}
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--column-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border-radius: 10px;
            border: 2px solid var(--column-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--button-hover);
        }

        body.dark ::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border: 2px solid var(--column-bg);
        }

        body.dark ::-webkit-scrollbar-thumb:hover {
            background-color: var(--button-hover);
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            font-size: 16px;
        }

        .tab-button.active {
            background-color: var(--button-hover);
            transform: none;
        }

        .activity-log {
            background: var(--column-bg);
            padding: 20px;
            border-radius: 15px;
            margin-top: 14px;
            box-shadow: var(--shadow-light);
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activity-table th, .activity-table td {
            padding: 10px;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .activity-table th {
            background: var(--button-bg);
            color: white;
        }
        select {
            padding: 12px 40px 12px 16px; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è */
            border: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≥—Ä–∞–Ω–∏—Ü—É –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ */
            border-radius: 12px; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã, –∫–∞–∫ —É –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            font-size: 16px; /* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —à—Ä–∏—Ñ—Ç–∞–º –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            font-weight: 500; /* –°—Ä–µ–¥–Ω–∏–π –≤–µ—Å –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
            background: var(--column-bg); /* –§–æ–Ω –≤ —Å—Ç–∏–ª–µ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ */
            color: var(--text-color); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã */
            width: 100%; /* –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
            cursor: pointer;
            transition: all 0.3s ease; /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —Å–≤–æ–π—Å—Ç–≤ */
            appearance: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ —Å—Ç—Ä–µ–ª–∫–∏ */
            box-shadow: var(--shadow-light); /* –¢–µ–Ω—å –≤ —Å—Ç–∏–ª–µ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            position: relative; /* –î–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å—Ç—Ä–µ–ª–∫–∏ */
        
            /* –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%234a2f3b"><path d="M5.5 7.5l4.5 4.5 4.5-4.5" stroke="%234a2f3b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 16px center; /* –°—Ç—Ä–µ–ª–∫–∞ –±–ª–∏–∂–µ –∫ –∫—Ä–∞—é */
            background-size: 16px; /* –†–∞–∑–º–µ—Ä —Å—Ç—Ä–µ–ª–∫–∏ —á—É—Ç—å –±–æ–ª—å—à–µ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
        }
        
        select:hover {
            background-color: var(--button-hover); /* –¶–≤–µ—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏, –∫–∞–∫ —É –∫–Ω–æ–ø–æ–∫ */
            box-shadow: 0 0 8px rgba(248, 184, 198, 0.4); /* –£—Å–∏–ª–µ–Ω–Ω–∞—è —Ç–µ–Ω—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
            transform: translateY(-1px); /* –õ–µ–≥–∫–∏–π –ø–æ–¥—ä–µ–º, –∫–∞–∫ —É –∫–Ω–æ–ø–æ–∫ */
        }
        
        select:focus {
            outline: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π outline */
            box-shadow: 0 0 10px rgba(248, 184, 198, 0.6); /* –Ø—Ä–∫–∞—è —Ç–µ–Ω—å –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
            background-color: #fff; /* –ß–∏—Å—Ç—ã–π –±–µ–ª—ã–π —Ñ–æ–Ω –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
        }
        
        select:active {
            transform: scale(0.98); /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è, –∫–∞–∫ —É –∫–Ω–æ–ø–æ–∫ */
        }
        
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        body.dark select {
            background: linear-gradient(180deg, rgba(60, 35, 45, 0.95) 0%, rgba(45, 25, 35, 0.95) 100%); /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
            color: var(--text-color); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
            box-shadow: var(--shadow-dark); /* –¢–µ–Ω—å –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
            background-image: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%234a2f3b"><path d="M5.5 7.5l4.5 4.5 4.5-4.5" stroke="%234a2f3b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>');
        }
        
        body.dark select:hover {
            background: linear-gradient(180deg, rgba(70, 40, 50, 0.95) 0%, rgba(55, 30, 40, 0.95) 100%); /* –õ–µ–≥–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
            box-shadow: 0 0 8px rgba(244, 196, 206, 0.5); /* –¢–µ–Ω—å –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
        }
        
        body.dark select:focus {
            background: rgba(70, 40, 50, 0.95); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
            box-shadow: 0 0 10px rgba(244, 196, 206, 0.7); /* –Ø—Ä–∫–∞—è —Ç–µ–Ω—å */
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
            select {
                padding: 10px 35px 10px 14px; /* –ú–µ–Ω—å—à–∏–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ */
                font-size: 14px; /* –ú–µ–Ω—å—à–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
                background-size: 14px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ */
                border-radius: 10px; /* –ú–µ–Ω—å—à–∏–π —Ä–∞–¥–∏—É—Å –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ */
            }
        }

        .icon-btn.active {
        background: var(--button-hover);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        transform: translateY(-1px);
        }

        .icon-btn, .icon-tab {
        width: 36px;
        height: 36px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: var(--button-bg);
        color: var(--text-color);
        border: none;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
        }

        .icon-btn.cont
        {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        .icon-btn:hover, .icon-tab:hover {
        transform: translateY(-2px);
        background: var(--button-hover);
        }
        .icon-tab.active {
        background: var(--button-hover);
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        /* —É–º–µ–Ω—å—à–∏–º –æ—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ –ø–æ–¥ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .modal-content .compact-row { display:flex; gap:8px; align-items:center; }

        /* visually-hidden for screen-readers */
        .sr-only {
        position: absolute !important;
        width: 1px; height: 1px;
        padding: 0; margin: -1px;
        overflow: hidden; clip: rect(0,0,0,0);
        white-space: nowrap; border: 0;
        }

        /* —á—É—Ç—å –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ textarea/inputs –≤ –º–æ–¥–∞–ª–∫–µ */
        .modal-content .result-textarea { height: 120px; font-size: 14px; padding: 8px; }
        .number-input { padding: 10px; font-size: 15px; }

    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE_URL = "https://otp-2-fos4.onrender.com";
        const ACCESS_TOKEN_STORAGE_KEY = "otp_access_token";
        const REFRESH_TOKEN_STORAGE_KEY = "otp_refresh_token";

        const readStoredToken = (key) => localStorage.getItem(key) || "";
        const writeStoredToken = (key, value) => {
            if (value) localStorage.setItem(key, value);
            else localStorage.removeItem(key);
        };
        const clearStoredTokens = () => {
            localStorage.removeItem(ACCESS_TOKEN_STORAGE_KEY);
            localStorage.removeItem(REFRESH_TOKEN_STORAGE_KEY);
        };

        const App = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [buttons, setButtons] = useState({ pending: [], completed: [], deferred: [] });
            const [timersRef] = useState(useRef(new Map()));
            const [notification, setNotification] = useState({ show: false, message: '' });
            const [selectedButtons, setSelectedButtons] = useState([]);
            const [fromValue, setFromValue] = useState('');
            const [startButton, setStartButton] = useState('');
            const [result, setResult] = useState('');
            const [activeOperators, setActiveOperators] = useState([]);
            const [isDividing, setIsDividing] = useState(false);
            const [isFetchingOperators, setIsFetchingOperators] = useState(false);
            const [showTimerModal, setShowTimerModal] = useState(null);
            const [timerHours, setTimerHours] = useState('');
            const [timerMinutes, setTimerMinutes] = useState('');
            const [timerSeconds, setTimerSeconds] = useState('');
            const [showAddButtonModal, setShowAddButtonModal] = useState(false);
            const [newButtonNumber, setNewButtonNumber] = useState('');
            const [loggedIn, setLoggedIn] = useState(false);
            const [loginValue, setLoginValue] = useState('');
            const [passwordValue, setPasswordValue] = useState('');
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [userData, setUserData] = useState(null);
            const [isTogglingActive, setIsTogglingActive] = useState(false);
            const [month, setMonth] = useState('');
            const [isGeneratingReport, setIsGeneratingReport] = useState(false);
            const petalsRef = useRef(null);
            const [currentTab, setCurrentTab] = useState('tasks');
            const [activityLogs, setActivityLogs] = useState([]);
            const [showStatusSelect, setShowStatusSelect] = useState(false);
            const [selectedStatus, setSelectedStatus] = useState('');
            const [showStatusModal, setShowStatusModal] = useState(false);
            const [modalStatus, setModalStatus] = useState('');
            const [operators, setOperators] = useState([]);  // –°–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è 'sv'
            const [selectedOperator, setSelectedOperator] = useState(null);  // –í—ã–±—Ä–∞–Ω–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [modalTab, setModalTab] = useState('add');   // 'add' | 'export' | 'import'
            const [importText, setImportText] = useState('');
            const [deferredNotifyMode, setDeferredNotifyMode] = useState(
            localStorage.getItem('deferredNotifyMode') || 'open' // 'open' –∏–ª–∏ 'notify'
            );

            useEffect(() => {
            localStorage.setItem('deferredNotifyMode', deferredNotifyMode);
            }, [deferredNotifyMode]);

            const persistAuthTokens = (accessToken, refreshToken) => {
                if (typeof accessToken !== "undefined") {
                    writeStoredToken(ACCESS_TOKEN_STORAGE_KEY, accessToken);
                }
                if (typeof refreshToken !== "undefined") {
                    writeStoredToken(REFRESH_TOKEN_STORAGE_KEY, refreshToken);
                }
            };

            const getAuthHeaders = (extraHeaders = {}, keyOverride = apiKey, userIdOverride = userData?.id) => {
                const headers = { ...(extraHeaders || {}) };
                const accessToken = readStoredToken(ACCESS_TOKEN_STORAGE_KEY);
                const refreshToken = readStoredToken(REFRESH_TOKEN_STORAGE_KEY);

                if (accessToken && !headers.Authorization) {
                    headers.Authorization = `Bearer ${accessToken}`;
                }
                if (refreshToken && !headers["X-Refresh-Token"]) {
                    headers["X-Refresh-Token"] = refreshToken;
                }
                if (keyOverride && !headers["X-API-Key"]) {
                    headers["X-API-Key"] = keyOverride;
                }
                if (userIdOverride && !headers["X-User-Id"]) {
                    headers["X-User-Id"] = userIdOverride;
                }
                return headers;
            };

            const clearSession = (withNotification = true) => {
                setLoggedIn(false);
                setUserData(null);
                setApiKey('');
                localStorage.removeItem("apiKey");
                localStorage.removeItem("userData");
                clearStoredTokens();
                if (withNotification) {
                    showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
                }
            };

            const refreshJwtSession = async () => {
                const refreshToken = readStoredToken(REFRESH_TOKEN_STORAGE_KEY);
                if (!refreshToken) {
                    throw new Error("NO_REFRESH_TOKEN");
                }

                const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
                    method: "POST",
                    credentials: "include",
                    headers: getAuthHeaders({ "Content-Type": "application/json" }),
                    body: JSON.stringify({})
                });

                let data = {};
                try {
                    data = await response.json();
                } catch (_) {
                    data = {};
                }

                if (!response.ok || data.status !== "success") {
                    throw new Error(data.error || "JWT refresh failed");
                }

                persistAuthTokens(data.access_token, data.refresh_token);
                return data;
            };

            const apiFetch = async (url, options = {}, opts = {}) => {
                const {
                    retryOnAuth = true,
                    keyOverride = apiKey,
                    userIdOverride = userData?.id
                } = opts;

                const requestOptions = {
                    credentials: "include",
                    ...options,
                    headers: getAuthHeaders(options.headers || {}, keyOverride, userIdOverride)
                };

                let response = await fetch(url, requestOptions);

                const isAuthEndpoint = url.includes("/api/login") || url.includes("/api/auth/refresh");
                if (
                    retryOnAuth &&
                    !isAuthEndpoint &&
                    response.status === 401 &&
                    readStoredToken(REFRESH_TOKEN_STORAGE_KEY)
                ) {
                    try {
                        await refreshJwtSession();
                        response = await fetch(url, {
                            ...requestOptions,
                            headers: getAuthHeaders(options.headers || {}, keyOverride, userIdOverride)
                        });
                    } catch (_) {
                        clearSession(false);
                    }
                }

                return response;
            };


            const getDeferredJson = () => {
                const deferred = buttons.deferred.map(b => {
                    const id = b.id;
                    const endTime = parseInt(localStorage.getItem(`timer_${id}`)) || null;
                    const restartCount = parseInt(localStorage.getItem(`restartCount_${id}`) || '0');
                    return { id, num: b.num, endTime, restartCount };
                });
                return JSON.stringify({ deferred }, null, 2); // pretty for preview
            };

            const fetchOperators = async (apiKey, userId) => {
                try {
                    const today = new Date().toISOString();
                    console.log(today);
                    const response = await apiFetch(
                        `${API_BASE_URL}/api/sv/operators`,
                        { headers: {} },
                        { keyOverride: apiKey, userIdOverride: userId }
                    );
                    const data = await response.json();
                    if (data.status === 'success') {
                        setOperators(data.operators);
                        if (data.operators.length > 0) {
                            setSelectedOperator(data.operators[0].id);
                        }
                    } else {
                        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤: ' + data.error);
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤');
                }
            };
            
            useEffect(() => {
                if (userData && userData.role === 'sv' && selectedOperator) {
                    fetchActivityLogs(apiKey, userData.id, selectedOperator);  // –ó–∞–≥—Ä—É–∂–∞—Ç—å –ª–æ–≥–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                }
            }, [selectedOperator, userData, apiKey]);

            useEffect(() => {
                document.body.className = theme === 'dark' ? 'dark' : '';
                localStorage.setItem('theme', theme);
            }, [theme]);
            
            useEffect(() => {
                const savedApiKey = localStorage.getItem("apiKey") || "";
                const savedUserData = localStorage.getItem("userData");
                const hasStoredTokens = !!readStoredToken(ACCESS_TOKEN_STORAGE_KEY) || !!readStoredToken(REFRESH_TOKEN_STORAGE_KEY);

                if (!savedUserData || (!savedApiKey && !hasStoredTokens)) {
                    return;
                }

                try {
                    const parsedUser = JSON.parse(savedUserData);
                    const restoredApiKey = savedApiKey || parsedUser.apiKey || "";

                    setApiKey(restoredApiKey);
                    setUserData(parsedUser);
                    setLoggedIn(true);
                    fetchActiveOperators(restoredApiKey);

                    if (parsedUser.role === "sv") {
                        fetchOperators(restoredApiKey, parsedUser.id);
                        setCurrentTab('activity');
                    } else {
                        fetchActivityLogs(restoredApiKey, parsedUser.id, parsedUser.id, true);
                    }
                } catch (_) {
                    localStorage.removeItem("userData");
                    clearStoredTokens();
                }
            }, []);
            
            useEffect(() => {
                const loadButtons = () => {
                    const saved = localStorage.getItem('buttons');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        setButtons(parsed);
                        Object.entries(parsed).forEach(([column, btns]) => {
                            btns.forEach(btn => {
                                const endTime = localStorage.getItem(`timer_${btn.id}`);
                                if (endTime && column === 'deferred') {
                                    const remaining = Math.max(0, parseInt(endTime) - Date.now());
                                    if (remaining > 0) {
                                        startTimer(btn.id, remaining / 1000);
                                    } else {
                                        localStorage.removeItem(`timer_${btn.id}`);
                                        localStorage.removeItem(`restartCount_${btn.id}`);
                                    }
                                }
                            });
                        });
                    }
                };
                loadButtons();
            }, []);

            useEffect(() => {
                localStorage.setItem('buttons', JSON.stringify(buttons));
            }, [buttons]);

            useEffect(() => {
                createPetals();
            }, []);

            useEffect(() => {
              const savedStatus = localStorage.getItem("lastStatus");
              if (savedStatus) setSelectedStatus(savedStatus);
            }, []);

            useEffect(() => {
              if (selectedStatus) localStorage.setItem("lastStatus", selectedStatus);
            }, [selectedStatus]);

            const createPetals = () => {
                const petalsContainer = petalsRef.current;
                if (!petalsContainer) return;
                petalsContainer.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const petal = document.createElement('div');
                    petal.className = 'petal';
                    petal.style.left = `${Math.random() * 100}%`;
                    petal.style.animationDuration = `${Math.random() * 10 + 10}s`;
                    petal.style.animationDelay = `${Math.random() * 5}s`;
                    petalsContainer.appendChild(petal);
                }
            };

            const toggleTheme = () => {
                setTheme(prev => prev === 'dark' ? 'light' : 'dark');
            };

            const toggleSidebar = () => {
                setSidebarOpen(prev => !prev);
            };

            const handleLogin = async () => {
                setIsLoggingIn(true);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/login`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ login: loginValue, password: passwordValue })
                    });
             
                    let data = {};
                    try {
                        data = await res.json();
                    } catch (_) {
                        data = {};
                    }
            
                    if (res.ok && data.status === 'success') {
                        const payloadUser = data.user || { id: data.id, name: data.name, role: data.role };
                        const nextApiKey = data.apiKey || '';
                        const user = { id: payloadUser.id, name: payloadUser.name, role: payloadUser.role, isActive: false, apiKey: nextApiKey };
                        persistAuthTokens(data.access_token, data.refresh_token);
                        setApiKey(nextApiKey);
                        setUserData(user);
                        console.log("USER OBJECT:", user);
            
                        setLoggedIn(true);
                        showNotification('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω!');
                        if (nextApiKey) {
                            localStorage.setItem("apiKey", nextApiKey);
                        } else {
                            localStorage.removeItem("apiKey");
                        }
                        localStorage.setItem("userData", JSON.stringify(user));
            
                        fetchActiveOperators(nextApiKey);
            
                        // üîç –õ–æ–≥–∏—Ä—É–µ–º —Ä–æ–ª—å
                        console.log("ROLE FROM BACKEND:", user.role);
            
                        if (user && user.role && user.role.toLowerCase() === "sv") {
                            fetchOperators(nextApiKey, user.id);
                            setCurrentTab('activity');
                        } else {
                            console.log("‚õî fetchOperators –ù–ï –≤—ã–∑–≤–∞–Ω, —Ä–æ–ª—å:", user.role);
                        }
            
                        await fetchActivityLogs(nextApiKey, user.id, user.id, true);
            
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                    }
                } catch (err) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                setIsLoggingIn(false);
            };


            const fetchUserProfile = async (userId) => {
                try {
                    const res = await apiFetch(
                        `${API_BASE_URL}/api/user/profile?user_id=${userId}`,
                        { headers: {} },
                        { keyOverride: apiKey, userIdOverride: userId }
                    );
                    const data = await res.json();
                    if (res.ok && data.status === 'success') {
                        setUserData(prev => ({ ...prev, isActive: data.profile.is_active }));
                    }
                } catch (err) {
                    console.error('Error fetching profile:', err);
                }
            };

            const handleLogout = async () => {
                try {
                    await apiFetch(
                        `${API_BASE_URL}/api/logout`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        },
                        { retryOnAuth: false, keyOverride: apiKey, userIdOverride: userData?.id }
                    );
                } catch (_) {
                    // ignore logout transport errors and clear local session anyway
                }
                clearSession(false);
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
            };

            const toggleActive = async (newStatus) => {
                setIsTogglingActive(true);
                try {
                    const res = await apiFetch(`${API_BASE_URL}/api/user/toggle_active`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: newStatus })
                    }, {
                        keyOverride: apiKey,
                        userIdOverride: userData?.id
                    });
                    const data = await res.json();
                    if (res.ok && (data.status === 'success' || data.status === 'unchanged')) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º isActive –≤ false –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤, –∫—Ä–æ–º–µ 'active'
                        setUserData(prev => ({ ...prev, isActive: newStatus === 'active' }));
                        showNotification(`–°—Ç–∞—Ç—É—Å: ${newStatus}`);
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞');
                    }
                } catch (err) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                setIsTogglingActive(false);
                setShowStatusSelect(false); // –ó–∞–∫—Ä—ã–≤–∞–µ–º select –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
            };

            const fetchActiveOperators = async (key) => {
                setIsFetchingOperators(true);
                try {
                    const res = await apiFetch(
                        `${API_BASE_URL}/api/active_operators`,
                        { headers: {} },
                        { keyOverride: key }
                    );
                    const data = await res.json();
                    if (res.ok && data.status === 'success') {
                        setActiveOperators(data.operators);
                    } else {
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤');
                    }
                } catch (err) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                setIsFetchingOperators(false);
            };

            const generateReport = async () => {
                setIsGeneratingReport(true);
                try {
                    const res = await apiFetch(
                        `${API_BASE_URL}/api/report/monthly?month=${month}`,
                        { headers: {} },
                        { keyOverride: apiKey, userIdOverride: userData?.id }
                    );
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report_${month}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        showNotification('–û—Ç—á–µ—Ç —Å–∫–∞—á–∞–Ω!');
                    } else {
                        const data = await res.json();
                        showNotification(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
                    }
                } catch (err) {
                    showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                setIsGeneratingReport(false);
            };

            const fetchActivityLogs = async (key = apiKey, userId = userData?.id, operatorId = userData?.id, updateStatus = false) => {
              try {
                const dateToFormat = new Date();
                const year = dateToFormat.getFullYear();
                const month = String(dateToFormat.getMonth() + 1).padStart(2, '0'); // –ú–µ—Å—è—Ü—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 0
                const day = String(dateToFormat.getDate()).padStart(2, '0');
                const today = `${year}-${month}-${day}`;
                const res = await apiFetch(
                  `${API_BASE_URL}/api/operator/activity?operator_id=${operatorId}&date=${today}`,
                  { headers: {} },
                  { keyOverride: key, userIdOverride: userId }
                );
                const data = await res.json();
                if (res.ok && data.status === 'success') {
                  setActivityLogs(data.logs);
            
                  // === –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –≤—Ö–æ–¥–µ ===
                  if (updateStatus && data.logs.length > 0) {
                    const lastLog = data.logs[data.logs.length - 1];
                    setSelectedStatus(lastLog.is_active);
                    localStorage.setItem("lastStatus", lastLog.is_active);
                  }
                } else {
                  showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤');
                }
              } catch (err) {
                showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
              }
            };

            useEffect(() => {
                if (currentTab === 'activity' && userData?.role === 'operator') {
                    fetchActivityLogs();
                }
            }, [currentTab]);

            const formatDuration = (ms) => {
                if (ms <= 0) return '0s';
                const seconds = Math.floor((ms / 1000) % 60);
                const minutes = Math.floor((ms / 1000 / 60) % 60);
                const hours = Math.floor(ms / 1000 / 3600);
                return `${hours > 0 ? hours + 'h ' : ''}${minutes > 0 ? minutes + 'm ' : ''}${seconds}s`;
            };

            const computeActivity = () => {
                if (!activityLogs.length) return [];
                const now = new Date();
                const computed = [];
                for (let i = 0; i < activityLogs.length; i++) {
                    const log = activityLogs[i];
                    const changeTime = new Date(log.change_time);
                    const nextTime = i < activityLogs.length - 1 ? new Date(activityLogs[i + 1].change_time) : now;
                    const duration = nextTime - changeTime;
                    computed.push({
                        time: changeTime.toLocaleTimeString(),
                        status: log.is_active,
                        duration: formatDuration(duration)
                    });
                }
                return computed;
            };

            const addButtons = async () => {
                let from = parseInt(fromValue);
                if (isNaN(from)) {
                    showNotification('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è!');
                    return;
                }

                await fetchActiveOperators(apiKey);

                setTimeout(() => {
                    const userName = userData?.name;

                    const currentOp = activeOperators.find(op => op.id === userData.id);

                    if (!currentOp) {
                        showNotification('–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ –ê–∫—Ç–∏–≤–Ω—ã–π —á—Ç–æ –±—ã –¥–µ–ª–∏—Ç—å!');
                        return;
                    }

                    // –±–µ—Ä—ë–º –µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    const userDirId = currentOp.direction_id;

                    const activeOpNames = activeOperators
                        .filter(a => a.direction_id === userDirId)
                        .map(a => a.name);

                    const stepValue = activeOpNames.length || 1;
                    const sortedNames = [...activeOpNames].sort();

                    const uIndex = sortedNames.indexOf(userName);

                    let toValue = from + 100;
                    from = from + ((uIndex - (from % stepValue) + stepValue) % stepValue);

                    // —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–Ω–æ–ø–æ–∫
                    const existingNums = new Set(
                        Object.values(buttons).flat().map(b => b.num)
                    );

                    const newBtns = [];
                    for (let i = from; i <= toValue; i += stepValue) {
                        if (!existingNums.has(i)) {   // ‚úÖ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
                            newBtns.push({ id: `${Date.now()}-${i}`, num: i });
                        }
                    }

                    if (newBtns.length === 0) {
                        showNotification('–ù–µ—Ç –Ω–æ–≤—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è!');
                        return;
                    }

                    setButtons(prev => ({
                        ...prev,
                        pending: [...prev.pending, ...newBtns]
                    }));
                    showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–∏–∫–µ—Ç–æ–≤: ${newBtns.length}`);
                }, 200);
            };

            const addSingleDeferredButton = () => {
                const num = parseInt(newButtonNumber);
                if (isNaN(num) || num < 1) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä!');
                    return;
                }

                // –ò—â–µ–º –≤ —Ç–µ–∫—É—â–∏—Ö –∫–Ω–æ–ø–∫–∞—Ö (–≤ –ª—é–±—ã—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö) –ø–æ num
                const allButtons = Object.values(buttons).flat();
                const existing = allButtons.find(b => b.num === num);

                if (existing) {
                    // –ï—Å–ª–∏ —É–∂–µ –≤ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ—Å—Ç–æ —É–≤–µ–¥–æ–º–ª—è–µ–º –∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                    const isInDeferred = buttons.deferred.some(b => b.id === existing.id);
                    if (isInDeferred) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–π–º–µ—Ä ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –∏–ª–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
                        showNotification('–¢–∏–∫–µ—Ç —É–∂–µ –≤ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ.');
                        // –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
                        // if (timersRef.current.has(existing.id)) {
                        //     clearInterval(timersRef.current.get(existing.id));
                        //     timersRef.current.delete(existing.id);
                        // }
                        // startTimer(existing.id, 900);
                        setShowAddButtonModal(false);
                        setNewButtonNumber('');
                        return;
                    }

                    // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å: —É–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–≥–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ deferred (—Å —Ç–µ–º –∂–µ id)
                    setButtons(prev => {
                        const next = { ...prev };
                        Object.keys(next).forEach(col => {
                            next[col] = next[col].filter(b => b.id !== existing.id);
                        });
                        next.deferred = [...next.deferred, existing];
                        return next;
                    });

                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–º–µ—â—ë–Ω–Ω–æ–≥–æ —Ç–∏–∫–µ—Ç–∞ (15 –º–∏–Ω—É—Ç)
                    startTimer(existing.id, 900);

                    showNotification('–¢–∏–∫–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ!');
                    setShowAddButtonModal(false);
                    setNewButtonNumber('');
                    return;
                }

                // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ deferred
                const newBtn = { id: `${Date.now()}-${num}`, num };
                setButtons(prev => ({ ...prev, deferred: [...prev.deferred, newBtn] }));

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å—Ä–∞–∑—É (15 –º–∏–Ω—É—Ç = 900 —Å–µ–∫)
                startTimer(newBtn.id, 900);

                showNotification('–¢–∏–∫–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ!');
                setShowAddButtonModal(false);
                setNewButtonNumber('');
            };

            const exportDeferred = () => {
                const deferred = buttons.deferred.map(b => {
                    const id = b.id;
                    const endTime = parseInt(localStorage.getItem(`timer_${id}`)) || null; // ms or null
                    const restartCount = parseInt(localStorage.getItem(`restartCount_${id}`) || '0');
                    return { id, num: b.num, endTime, restartCount };
                });

                const payload = JSON.stringify({ deferred }, null, 0); // –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±–º–µ–Ω–∞

                // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(payload).then(() => {
                        showNotification('–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä!');
                    }).catch(() => {
                        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä.');
                    });
                } else {
                    showNotification('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.');
                }

                // –¢–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–∫–∞—á–∞—Ç—å .json
                try {
                    const blob = new Blob([payload], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `deferred_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    console.error(err);
                }
            };

            // --- –ò–º–ø–æ—Ä—Ç –∏–∑ —Ç–µ–∫—Å—Ç–∞ (JSON) –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ ---
            const importDeferredFromText = (text) => {
                try {
                    const parsed = JSON.parse(text);
                    if (!parsed || !Array.isArray(parsed.deferred)) {
                        showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –û–∂–∏–¥–∞–µ—Ç—Å—è {"deferred":[{...}, ...]}');
                        return;
                    }

                    // –°–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ —Å—Ç–∞—Ä—Ç—É —Ç–∞–π–º–µ—Ä–æ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    const startActions = [];

                    setButtons(prev => {
                        const next = { ...prev };
                        // –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                        if (!next.pending) next.pending = [];
                        if (!next.completed) next.completed = [];
                        if (!next.deferred) next.deferred = [];

                        parsed.deferred.forEach(item => {
                            const num = parseInt(item.num);
                            if (isNaN(num)) return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –Ω–æ–º–µ—Ä–∞

                            // –ù–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–∏–∫–µ—Ç –ø–æ num (–≤ –ª—é–±–æ–π –∫–æ–ª–æ–Ω–∫–µ)
                            const existing = Object.values(next).flat().find(b => b.num === num);

                            // –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –Ω–∞–π–¥–µ–Ω ‚Äî –±—É–¥–µ–º –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ id
                            let idToUse;
                            if (existing) {
                                // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
                                Object.keys(next).forEach(col => {
                                    next[col] = next[col].filter(b => b.num !== num);
                                });
                                idToUse = existing.id;
                            } else {
                                // –í–æ–∑—å–º—ë–º id –∏–∑ –∏–º–ø–æ—Ä—Ç–∞, –ª–∏–±–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
                                idToUse = item.id || `${Date.now()}-${num}-${Math.floor(Math.random()*1000)}`;
                            }

                            // –î–æ–±–∞–≤–ª—è–µ–º –≤ deferred (–µ—Å–ª–∏ —É–∂–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω)
                            if (!next.deferred.some(b => b.num === num)) {
                                next.deferred.push({ id: idToUse, num });
                            }

                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º restartCount (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –∑–∞–ø–æ–º–Ω–∏–º –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ setButtons
                            const rc = typeof item.restartCount !== 'undefined' ? parseInt(item.restartCount) || 0 : 0;
                            const endTime = item.endTime ? parseInt(item.endTime) : null;

                            startActions.push({ id: idToUse, endTime, restartCount: rc });
                        });

                        return next;
                    });

                    // –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è state ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å) —Ç–∞–π–º–µ—Ä—ã –∏ restartCount
                    setTimeout(() => {
                        startActions.forEach(act => {
                            const id = act.id;
                            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º restartCount –≤ localStorage
                            if (typeof act.restartCount !== 'undefined') {
                                localStorage.setItem(`restartCount_${id}`, String(act.restartCount));
                            }

                            if (act.endTime && !isNaN(act.endTime)) {
                                const remainingMs = parseInt(act.endTime) - Date.now();
                                if (remainingMs > 0) {
                                    // –£—Å—Ç–∞–Ω–æ–≤–∏–º endTime –≤ localStorage (—á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –±—ã–ª–æ –≤–∏–¥–Ω–æ) –∏ –∑–∞–ø—É—Å—Ç–∏–º —Ç–∞–π–º–µ—Ä —Å –æ—Å—Ç–∞–≤—à–∏–º—Å—è –≤—Ä–µ–º–µ–Ω–µ–º
                                    localStorage.setItem(`timer_${id}`, String(act.endTime));
                                    // startTimer –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—à–µ—Ç timer_{id} –∑–∞–Ω–æ–≤–æ –∏ —Å–æ–∑–¥–∞—Å—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª
                                    startTimer(id, Math.ceil(remainingMs / 1000));
                                } else {
                                    // –í—Ä–µ–º—è —É–∂–µ –∏—Å—Ç–µ–∫–ª–æ ‚Äî –æ—á–∏—Å—Ç–∏–º –∑–∞–ø–∏—Å–∏
                                    localStorage.removeItem(`timer_${id}`);
                                    // –Ω–µ —É–¥–∞–ª—è–µ–º restartCount ‚Äî –ø—É—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                                }
                            }
                        });
                    }, 150);

                    showNotification('–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                } catch (err) {
                    console.error(err);
                    showNotification('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON.');
                }
            };

            // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ .json —Ñ–∞–π–ª–∞ ---
            const handleImportFile = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = () => {
                    importDeferredFromText(reader.result);
                };
                reader.readAsText(file);
            };

            const showNotification = (msg) => {
                setNotification({ show: true, message: msg });
                setTimeout(() => setNotification({ show: false, message: '' }), 3000);
            };

            const startTimer = (id, duration) => {
            const endTime = Date.now() + duration * 1000;
            localStorage.setItem(`timer_${id}`, endTime);
            updateTimerDisplay(id, duration);

            const interval = setInterval(() => {
                const remaining = Math.max(0, endTime - Date.now());
                updateTimerDisplay(id, remaining / 1000);

                if (remaining <= 0) {
                clearInterval(interval);
                timersRef.current.delete(id);
                localStorage.removeItem(`timer_${id}`);

                // –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞ –∏–∑ id (–Ω–∞–ø—Ä–∏–º–µ—Ä "deferred-123" -> "123")
                const ticketNum = (typeof id === 'string' && id.includes('-')) ? id.split('-')[1] : id;
                const url = `https://backend.yataxi.kz/admin/list-tickets/${ticketNum}`;

                // –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ä–µ–∂–∏–º –∏–∑ localStorage (–ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é 'open')
                const deferredNotifyMode = localStorage.getItem('deferredNotifyMode') || 'open';

                // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                const showDesktopNotif = (title, body) => {
                    if ("Notification" in window) {
                    if (Notification.permission === "granted") {
                        const n = new Notification(title, { body, icon: "https://iili.io/3soEozX.png" });
                        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω–µ—Ç –ø–æ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ‚Äî –æ—Ç–∫—Ä–æ–µ–º —Ç–∏–∫–µ—Ç (–ø–æ–ª–µ–∑–Ω–æ –∫–∞–∫ fallback)
                        n.onclick = () => {
                        try { window.open(url, '_blank'); } catch (e) { /* ignore */ }
                        window.focus?.();
                        };
                    } else if (Notification.permission !== "denied") {
                        Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            const n = new Notification(title, { body, icon: "https://iili.io/3soEozX.png" });
                            n.onclick = () => {
                            try { window.open(url, '_blank'); } catch (e) { /* ignore */ }
                            window.focus?.();
                            };
                        } else {
                            showNotification(body);
                        }
                        }).catch(() => {
                        showNotification(body);
                        });
                    } else {
                        // denied
                        showNotification(body);
                    }
                    } else {
                    showNotification(body);
                    }
                };

                const tryOpenTicket = () => {
                    try {
                    const opened = window.open(url, '_blank');
                    // –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ—Ç–∫—Ä—ã—Ç–∏–µ (opened === null), –¥–∞–¥–∏–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                    if (!opened) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ) —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º, –∏ —Ç–µ–∫—Å—Ç–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                        showDesktopNotif("‚è∞ –¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ —Ç–∏–∫–µ—Ç", `–¢–∏–∫–µ—Ç ${ticketNum} –≥–æ—Ç–æ–≤: ${url}`);
                        // –ï—â—ë –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
                        showNotification(`–û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç –≤—Ä—É—á–Ω—É—é: ${url}`);
                    } else {
                        // —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                        showNotification(`–û—Ç–∫—Ä—ã—Ç —Ç–∏–∫–µ—Ç ${ticketNum}`);
                    }
                    } catch (e) {
                    // –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ ‚Äî —É–≤–µ–¥–æ–º–∏–º
                    showDesktopNotif("‚è∞ –¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω", `–¢–∏–∫–µ—Ç ${ticketNum} –∑–∞–≤–µ—Ä—à–∏–ª –æ—Ç—Å—á—ë—Ç`);
                    showNotification(`–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç ${ticketNum}`);
                    }
                };

                // –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (deferredNotifyMode === 'open') {
                    // –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å; –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–∫–∞–∂–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å URL
                    tryOpenTicket();
                } else {
                    // —Ç–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showDesktopNotif("‚è∞ –¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω!", `–ó–∞–¥–∞—á–∞ ${ticketNum} –∑–∞–∫–æ–Ω—á–∏–ª–∞ –æ—Ç—Å—á–µ—Ç.`);
                }

                // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (–∫–∞–∫ –±—ã–ª–æ —É –≤–∞—Å)
                setButtons(prev => ({ ...prev }));
                }
            }, 1000);

            timersRef.current.set(id, interval);
            };

            const updateTimerDisplay = (id, seconds) => {
                const timerEl = document.getElementById(`timer-${id}`);
                if (timerEl) {
                    const hrs = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    timerEl.textContent = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            };

            const promptForCustomTime = (id) => {
                setShowTimerModal(id);
            };

            const submitCustomTime = (id) => {
                const hours = parseInt(timerHours) || 0;
                const minutes = parseInt(timerMinutes) || 0;
                const seconds = parseInt(timerSeconds) || 0;
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                if (totalSeconds <= 0) {
                    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è!');
                    return;
                }
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                startTimer(id, totalSeconds);
                setShowTimerModal(null);
                setTimerHours('');
                setTimerMinutes('');
                setTimerSeconds('');
            };

            const restartTimer = (id) => {
                let restartCount = parseInt(localStorage.getItem(`restartCount_${id}`) || '0');
                restartCount++;
                localStorage.setItem(`restartCount_${id}`, restartCount);
                const duration = restartCount === 1 ? 1800 : 3600;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                startTimer(id, duration);
                setButtons(prev => ({ ...prev }));
            };

            const completeTask = (id, column) => {
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                setButtons(prev => {
                    const btn = prev.deferred.find(b => b.id === id);
                    if (!btn) return prev;
                    return {
                        ...prev,
                        deferred: prev.deferred.filter(b => b.id !== id),
                        completed: [...prev.completed, btn]
                    };
                });
            };

            const handleButtonClick = (e, btn, column) => {
                if (e.ctrlKey || e.metaKey) {
                    setSelectedButtons(prev => prev.some(s => s.id === btn.id) ? prev.filter(s => s.id !== btn.id) : [...prev, {...btn, column}]);
                } else {
                    setSelectedButtons([{...btn, column}]);
                }
            };

            const openSelectedInTabs = () => {
                if (selectedButtons.length === 0) return showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–∫–µ—Ç!');
                selectedButtons.forEach(btn => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank'));
            };

            const deleteButton = (btn) => {
                if (!confirm('–£–≤–µ—Ä–µ–Ω—ã?')) return;
                const id = btn.id;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                timersRef.current.delete(id);
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    Object.keys(newButtons).forEach(col => {
                        newButtons[col] = newButtons[col].filter(b => b.id !== id);
                    });
                    return newButtons;
                });
                setSelectedButtons(prev => prev.filter(s => s.id !== id));
                showNotification('–¢–∏–∫–µ—Ç —É–¥–∞–ª–µ–Ω!');
            };

            const dragStart = (e, btn) => {
                e.dataTransfer.setData('text/plain', JSON.stringify(btn));
                e.target.classList.add('dragging');
            };

            const dragEnd = (e) => {
                e.target.classList.remove('dragging');
            };

            const allowDrop = (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            };

            const drop = (e, targetColumn) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                setSelectedButtons([]);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    selectedButtons.forEach(selBtn => {
                        Object.keys(newButtons).forEach(col => {
                            newButtons[col] = newButtons[col].filter(b => b.id !== selBtn.id);
                        });
                        newButtons[targetColumn].push(selBtn);
                        if (targetColumn === 'deferred') {
                            startTimer(selBtn.id, 900);
                        } else if (selBtn.column === 'deferred') {
                            if (timersRef.current.has(selBtn.id)) clearInterval(timersRef.current.get(selBtn.id));
                            timersRef.current.delete(selBtn.id);
                            localStorage.removeItem(`timer_${selBtn.id}`);
                            localStorage.removeItem(`restartCount_${selBtn.id}`);
                        }
                    });
                    return newButtons;
                });
            };

            const clearColumn = (columnId) => {
                buttons[columnId].forEach(btn => {
                    if (timersRef.current.has(btn.id)) clearInterval(timersRef.current.get(btn.id));
                    timersRef.current.delete(btn.id);
                    localStorage.removeItem(`timer_${btn.id}`);
                    localStorage.removeItem(`restartCount_${btn.id}`);
                });
                setButtons(prev => ({ ...prev, [columnId]: [] }));
                showNotification(`–ö–æ–ª–æ–Ω–∫–∞ "${columnId}" –æ—á–∏—â–µ–Ω–∞!`);
            };

            const divideButtons = async () => {
              setIsDividing(true);
              await fetchActiveOperators(apiKey);
            
              const start = parseInt(startButton);
              if (isNaN(start) || start < 1) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä!');
                setIsDividing(false);
                return;
              }
            
              // –Ω–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ
              const currentOp = activeOperators.find(op => op.id === userData.id);
            
              if (!currentOp) {
                showNotification('–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –≤ –ê–∫—Ç–∏–≤–Ω—ã–π —á—Ç–æ –±—ã –¥–µ–ª–∏—Ç—å!');
                setIsDividing(false);
                return;
              }
            
              // –±–µ—Ä—ë–º –µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
              const dirId = currentOp.direction_id;
            
              // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —É –∫–æ–≥–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
              const filteredOps = activeOperators.filter(op => op.direction_id === dirId);
            
              if (filteredOps.length === 0) {
                showNotification('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –≤ –≤–∞—à–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏!');
                setIsDividing(false);
                return;
              }
            
              const res = filteredOps.map((op, index) =>
                `${start + index} - ${op.name.split(' ')[1]}`
              ).join('\n');
            
              setResult(res);
              showNotification('–¢–∏–∫–µ—Ç—ã –ø–æ–¥–µ–ª–µ–Ω—ã!');
              setIsDividing(false);
            };

            const copyResult = () => {
                navigator.clipboard.writeText(result);
                showNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
            };

            const renderButton = (btn, column) => {
                const id = btn.id;
                const endTime = localStorage.getItem(`timer_${id}`);
                const hasTimer = column === 'deferred' && endTime && (parseInt(endTime) > Date.now());
                const showControls = column === 'deferred' && !hasTimer;
                const isSelected = selectedButtons.some(s => s.id === id);
                return (
                    <button
                        key={id}
                        id={id}
                        className={`${column} ${isSelected ? 'selected' : ''}`}
                        draggable
                        onDragStart={(e) => dragStart(e, btn)}
                        onDragEnd={dragEnd}
                        onClick={(e) => handleButtonClick(e, btn, column)}
                        onDoubleClick={() => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank')}
                        onContextMenu={(e) => { e.preventDefault(); deleteButton(btn); }}
                    >
                        –¢–∏–∫–µ—Ç {btn.num}
                        {column === 'deferred' && (
                            <>
                                <div className="restart-badge">
                                    {(parseInt(localStorage.getItem(`restartCount_${id}`) || '0') + 1)}
                                </div>
                                <div className="timer-container">
                                    {hasTimer && (
                                        <>
                                            <div className="timer" id={`timer-${id}`}></div>
                                            <button className="edit-time-btn" onClick={() => promptForCustomTime(id)}>üñãÔ∏è</button>
                                        </>
                                    )}
                                </div>
                            </>
                        )}
                        {showControls && (
                            <>
                                <button className="timer-control" onClick={() => restartTimer(id)}>‚Üª</button>
                                <button className="timer-control" onClick={() => completeTask(id, column)}>‚úî</button>
                            </>
                        )}
                    </button>
                );
            };

            const renderActivityTab = () => {
              const computedActivity = computeActivity();
            
              // === —Å—á–∏—Ç–∞–µ–º –æ—Ç—Ä–µ–∑–∫–∏ –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–∞ ===
              const now = new Date();
              const startOfDay = new Date();
              startOfDay.setHours(0, 0, 0, 0);
            
              const segments = activityLogs.map((log, i) => {
                const start = new Date(log.change_time);
                const end = i < activityLogs.length - 1 ? new Date(activityLogs[i + 1].change_time) : now;
                const durationMs = end - start;
            
                return {
                  status: log.is_active,
                  start,
                  end,
                  durationMs,
                  duration: formatDuration(durationMs),
                  percentStart: ((start - startOfDay) / (24 * 3600 * 1000)) * 100,
                  percentWidth: (durationMs / (24 * 3600 * 1000)) * 100
                };
              });
            
              // === —Å—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å—Ç–∞—Ç—É—Å—É ===
              const totals = segments.reduce((acc, seg) => {
                acc[seg.status] = (acc[seg.status] || 0) + seg.durationMs;
                return acc;
              }, {});
            
              const statusColors = {
                active: "#4caf50",
                break: "#ff9800",
                tech: "#9c27b0",
                training: "#2196f3",
                inactive: "#f44336",
                iesigning: "#5195f5"
              };
            
              return (
                <div className="activity-log">
                  <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "15px" }}>
                      <h2 style={{ margin: 0 }}>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å {userData.role === 'sv' ? '–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤' : '–∑–∞ —Å–µ–≥–æ–¥–Ω—è'}</h2>
                      <button
                        onClick={async () => {
                          if (isRefreshing) return;
                          setIsRefreshing(true);
                          await fetchActivityLogs(apiKey, userData.id, selectedOperator || userData.id, true);
                          setTimeout(() => setIsRefreshing(false), 7000);
                        }}
                        disabled={isRefreshing}
                        style={{
                          padding: "8px 14px",
                          borderRadius: "8px",
                          fontSize: "16px",
                          display: "flex",
                          alignItems: "center",
                          justifyContent: "center",
                          gap: "6px",
                          backgroundColor: "var(--button-bg)",
                          color: "var(--text-color)",
                          border: "none",
                          boxShadow: "var(--shadow-light)",
                          cursor: isRefreshing ? "not-allowed" : "pointer",
                          opacity: isRefreshing ? 0.6 : 1
                        }}
                        title={isRefreshing ? "–ü–æ–¥–æ–∂–¥–∏—Ç–µ..." : "–û–±–Ω–æ–≤–∏—Ç—å"}
                      >
                        <i className="fas fa-sync-alt"></i>
                      </button>
                    </div>
                  {userData.role === 'sv' && (
                    <select
                      value={selectedOperator || ''}
                      onChange={(e) => setSelectedOperator(e.target.value)}
                    >
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</option>
                      {operators.map(op => (
                        <option key={op.id} value={op.id}>{op.name}</option>
                      ))}
                    </select>
                  )}
            
                  {selectedOperator || userData.role !== 'sv' ? (
                    <>
                      {/* === –¢–∞–π–º–ª–∞–π–Ω === */}
                      <div style={{ position: "relative", height: "30px", background: "#eee", marginBottom: "10px" }}>
                        {segments.map((seg, idx) => (
                        <div
                          key={idx}
                          title={`${seg.status} ‚Äî ${seg.duration}`}
                          style={{
                            position: "absolute",
                            left: `${Math.max(0, seg.percentStart)}%`,
                            width: `${
                              Math.min(100, seg.percentStart + seg.percentWidth) -
                              Math.max(0, seg.percentStart)
                            }%`,
                            height: "100%",
                            background: statusColors[seg.status] || "#999"
                          }}
                        />
                        ))}
                      </div>
                    
                      {/* === –ü–æ–¥–ø–∏—Å–∏ –≤—Ä–µ–º–µ–Ω–∏ === */}
                      <div style={{
                        display: "flex",
                        justifyContent: "space-between",
                        fontSize: "12px",
                        color: "#666",
                        marginBottom: "20px"
                      }}>
                        <span>00:00</span>
                        <span>06:00</span>
                        <span>12:00</span>
                        <span>18:00</span>
                        <span>24:00</span>
                      </div>
            
                      {/* === –°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º === */}
                      <div style={{ marginBottom: "20px" }}>
                        <h3>–°–≤–æ–¥–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
                        <ul style={{ listStyle: "none", padding: 0 }}>
                          {Object.entries(totals).map(([status, ms]) => {
                            let label = status;
            
                            if (status === "active") label = "–ê–∫—Ç–∏–≤–µ–Ω";
                            if (status === "break") label = "–ü–µ—Ä–µ—Ä—ã–≤";
                            if (status === "tech") label = "–¢–µ—Ö. –ø—Ä–∏—á–∏–Ω–∞";
                            if (status === "training") label = "–¢—Ä–µ–Ω–∏–Ω–≥";
                            if (status === "iesigning") label = "–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ";
            
                            // === –æ—Å–æ–±–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è inactive ===
                            if (status === "inactive") {
                              const inactiveLog = activityLogs.find(l => l.is_active === "inactive");
                              if (inactiveLog) {
                                const date = new Date(inactiveLog.change_time);
                                const hours = date.getHours().toString().padStart(2, "0");
                                const minutes = date.getMinutes().toString().padStart(2, "0");
                                label = `–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ ${hours}:${minutes}`;
                              } else {
                                label = "–°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
                              }
                            }
            
                            return (
                              <li key={status} style={{ margin: "4px 0" }}>
                                <span
                                  style={{
                                    display: "inline-block",
                                    width: "12px",
                                    height: "12px",
                                    background: statusColors[status] || "#999",
                                    marginRight: "8px"
                                  }}
                                ></span>
                                {label} {status !== "inactive" ? formatDuration(ms) : ""}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
            
                      {/* === –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ === */}
                      {computedActivity.length > 0 ? (
                        <table className="activity-table">
                          <thead>
                            <tr>
                              <th>–í—Ä–µ–º—è</th>
                              <th>–°—Ç–∞—Ç—É—Å</th>
                              <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                            </tr>
                          </thead>
                          <tbody>
                            {computedActivity.slice().reverse().map((entry, index) => (
                              <tr key={index}>
                                <td>{entry.time}</td>
                                <td>{entry.status}</td>
                                <td>{entry.duration}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      ) : (
                        <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è</p>
                      )}
                    </>
                  ) : (
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                  )}
                </div>
              );
            };

            if (!loggedIn) {
                return (
                    <div className="login-container">
                        <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
                        <input type="text" value={loginValue} onChange={(e) => setLoginValue(e.target.value)} placeholder="–õ–æ–≥–∏–Ω" />
                        <input type="password" value={passwordValue} onChange={(e) => setPasswordValue(e.target.value)} placeholder="–ü–∞—Ä–æ–ª—å" />
                        <button onClick={handleLogin} disabled={isLoggingIn}>
                            {isLoggingIn ? <div className="loader"></div> : '–í–æ–π—Ç–∏'}
                        </button>
                        <div className={`notification ${notification.show ? 'show' : ''}`}>{notification.message}</div>
                    </div>
                );
            }

            return (
                <>
                    <div className="petals" ref={petalsRef}></div>
                    <button className={`sidebar-toggle ${sidebarOpen ? 'open' : ''}`} onClick={toggleSidebar} aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤">üìù</button>
                    <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-content">
                            {userData.role === 'operator' && (
                              <>
                                <input type="number" value={startButton} onChange={(e) => setStartButton(e.target.value)} placeholder="–ù–∞—á–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞" />
                                <button onClick={divideButtons} disabled={isDividing || isFetchingOperators}>
                                    {isDividing || isFetchingOperators ? <div className="loader"></div> : '–ü–æ–¥–µ–ª–∏—Ç—å'}
                                </button>
                                <textarea className="result-textarea" value={result} readOnly />
                                <button onClick={copyResult}>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            </>
                            )}
                            {userData.role !== 'operator' && (
                                <>
                                    <input 
                                        type="month" 
                                        value={month} 
                                        onChange={(e) => setMonth(e.target.value)} 
                                        placeholder="–ú–µ—Å—è—Ü YYYY-MM" 
                                    />
                                    <button onClick={generateReport} disabled={isGeneratingReport}>
                                        {isGeneratingReport ? <div className="loader"></div> : '–û—Ç—á–µ—Ç'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                    {userData && (
                        <div className="user-info">
                            <span>{userData.name}</span>
                            <button onClick={handleLogout}>–í—ã–π—Ç–∏</button>
                        </div>
                    )}
                    <div className="tabs">
                        {userData.role !== 'sv' && (
                            <button 
                                className={`tab-button ${currentTab === 'tasks' ? 'active' : ''}`} 
                                onClick={() => setCurrentTab('tasks')}
                            >
                                –ó–∞–¥–∞—á–∏
                            </button>
                        )}
                        <button 
                            className={`tab-button ${currentTab === 'activity' ? 'active' : ''}`} 
                            onClick={() => setCurrentTab('activity')}
                        >
                            –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                        </button>
                    </div>
                    <div className="container">
                        {currentTab === 'tasks' ? (
                            <>
                                <div className="controls">
                                    <button 
                                        onClick={toggleTheme} 
                                        aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"
                                        className="theme-toggle-btn"
                                    >
                                        {theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
                                    </button>
                                    <input 
                                        type="number" 
                                        value={fromValue} 
                                        onChange={(e) => setFromValue(e.target.value)} 
                                        placeholder="–° –∫–∞–∫–æ–≥–æ —Ç–∏–∫–µ—Ç–∞"
                                        className="controls-input"
                                    />
                                    <button 
                                        onClick={addButtons} 
                                        aria-label="–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ç—ã"
                                        className="controls-btn"
                                    >
                                        –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ç—ã
                                    </button>
                                    <button 
                                        onClick={openSelectedInTabs} 
                                        aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ"
                                        className="controls-btn"
                                        disabled={selectedButtons.length === 0}
                                    >
                                        –û—Ç–∫—Ä—ã—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                                    </button>
                                </div>
                                <div className="columns">
                                    {['pending', 'completed', 'deferred'].map(column => (
                                        <div
                                            key={column}
                                            className="column"
                                            id={column}
                                            onDrop={(e) => drop(e, column)}
                                            onDragOver={allowDrop}
                                            onDragLeave={(e) => e.currentTarget.classList.remove('dragover')}
                                        >
                                            <h2>{column === 'pending' ? '–í—ã–ø–æ–ª–Ω—è–µ–º—ã–µ' : column === 'completed' ? '–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ' : '–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ'}</h2>
                                            <div className="list" id={`${column}List`}>
                                                {buttons[column]
                                                    .slice()
                                                    .sort((a, b) => a.num - b.num)
                                                    .map(btn => renderButton(btn, column))}
                                            </div>
                                            <div className="counter" id={`${column}Count`}>
                                                {buttons[column].length}
                                                {column === 'deferred' && (
                                                    <>
                                                    <div style={{ display: 'flex', gap: 8, alignItems: 'center', marginLeft: 8 }}>
                                                    <button
                                                        className={`icon-btn cont ${deferredNotifyMode === 'open' ? 'active' : ''}`}
                                                        onClick={() => setDeferredNotifyMode('open')}
                                                        aria-label="–û—Ç–∫—Ä—ã–≤–∞—Ç—å"
                                                        title="–û—Ç–∫—Ä—ã–≤–∞—Ç—å ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ç–∏–∫–µ—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ"
                                                    >
                                                        <i className="fas fa-external-link-alt" />
                                                        <span className="sr-only">–û—Ç–∫—Ä—ã–≤–∞—Ç—å</span>
                                                    </button>

                                                    <button
                                                        className={`icon-btn cont ${deferredNotifyMode === 'notify' ? 'active' : ''}`}
                                                        onClick={() => setDeferredNotifyMode('notify')}
                                                        aria-label="–£–≤–µ–¥–æ–º–ª—è—Ç—å"
                                                        title="–£–≤–µ–¥–æ–º–ª—è—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
                                                    >
                                                        <i className="fas fa-bell" />
                                                        <span className="sr-only">–£–≤–µ–¥–æ–º–ª—è—Ç—å</span>
                                                    </button>
                                                    </div>
                                                    <button className="add-button" onClick={() => setShowAddButtonModal(true)}>+</button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="clear-btn-container">
                                    <button className="clear-btn" onClick={() => clearColumn('pending')}>–û—á–∏—Å—Ç–∏—Ç—å –í—ã–ø–æ–ª–Ω—è–µ–º—ã–µ</button>
                                    <button className="clear-btn" onClick={() => clearColumn('completed')}>–û—á–∏—Å—Ç–∏—Ç—å –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
                                    <button className="clear-btn" onClick={() => clearColumn('deferred')}>–û—á–∏—Å—Ç–∏—Ç—å –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ</button>
                                </div>
                            </>
                        ) : (
                            renderActivityTab()
                        )}
                    </div>
                    {userData.role === 'operator' && (
                        <div className="status-selector">
                          <h3>–°—Ç–∞—Ç—É—Å</h3>
                          {!selectedStatus || selectedStatus === "inactive" ? (
                            <button 
                              onClick={() => { setSelectedStatus("active"); toggleActive("active"); }} 
                              disabled={isTogglingActive}
                            >
                              {isTogglingActive ? <div className="loader"></div> : "–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É"}
                            </button>
                          ) : selectedStatus === "active" ? (
                            <button onClick={() => { setModalStatus(selectedStatus === "active" ? "" : selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                              {isTogglingActive ? <div className="loader"></div> : "–í—ã –∞–∫—Ç–∏–≤–Ω—ã"}
                            </button>
                          ) : selectedStatus === "break" ? (
                            <button onClick={() => { setModalStatus(selectedStatus === "active" ? "" : selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                              {isTogglingActive ? <div className="loader"></div> : "–ù–µ –∞–∫—Ç–∏–≤–µ–Ω: –ü–µ—Ä–µ—Ä—ã–≤"}
                            </button>
                          ) : selectedStatus === "training" ? (
                            <button onClick={() => { setModalStatus(selectedStatus === "active" ? "" : selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                              {isTogglingActive ? <div className="loader"></div> : "–ù–µ –∞–∫—Ç–∏–≤–µ–Ω: –¢—Ä–µ–Ω–∏–Ω–≥"}
                            </button>
                          ) : selectedStatus === "tech" ? (
                            <button onClick={() => { setModalStatus(selectedStatus === "active" ? "" : selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                              {isTogglingActive ? <div className="loader"></div> : "–ù–µ –∞–∫—Ç–∏–≤–µ–Ω: –¢–µ—Ö. –ø—Ä–∏—á–∏–Ω–∞"}
                            </button>
                          ) : selectedStatus === "iesigning" ? (
                            <button onClick={() => { setModalStatus(selectedStatus === "active" ? "" : selectedStatus); setShowStatusModal(true)}} disabled={isTogglingActive}>
                              {isTogglingActive ? <div className="loader"></div> : "–ù–µ –∞–∫—Ç–∏–≤–µ–Ω: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ"}
                            </button>
                          ) : null}
                        </div>
                      )}
                    <div className={`notification ${notification.show ? 'show' : ''}`} id="notification">
                        {notification.message}
                    </div>
                    {showTimerModal && (
                        <div className="modal">
                            <div className="modal-content">
                                <h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä</h3>
                                <div className="time-inputs">
                                    <input
                                        type="number"
                                        value={timerHours}
                                        onChange={(e) => setTimerHours(e.target.value)}
                                        placeholder="–ß–ß"
                                        min="0"
                                        max="23"
                                    />
                                    <span>:</span>
                                    <input
                                        type="number"
                                        value={timerMinutes}
                                        onChange={(e) => setTimerMinutes(e.target.value)}
                                        placeholder="–ú–ú"
                                        min="0"
                                        max="59"
                                    />
                                    <span>:</span>
                                    <input
                                        type="number"
                                        value={timerSeconds}
                                        onChange={(e) => setTimerSeconds(e.target.value)}
                                        placeholder="–°–°"
                                        min="0"
                                        max="59"
                                    />
                                </div>
                                <div className="modal-buttons">
                                    <button onClick={() => submitCustomTime(showTimerModal)}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                    <button onClick={() => setShowTimerModal(null)}>–û—Ç–º–µ–Ω–∞</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showAddButtonModal && (
                    <div className="modal" onClick={() => { setShowAddButtonModal(false); setModalTab('add'); }}>
                        <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: 520 }}>
                        <h3 style={{ marginBottom: 12 }}>–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>

                        {/* Tabs (compact icon tabs) */}
                        <div style={{ display: 'flex', gap: 8, marginBottom: 12, alignItems: 'center' }}>
                            <button
                            className={`icon-tab ${modalTab === 'add' ? 'active' : ''}`}
                            onClick={() => setModalTab('add')}
                            aria-label="–î–æ–±–∞–≤–∏—Ç—å"
                            title="–î–æ–±–∞–≤–∏—Ç—å"
                            >
                            <i className="fas fa-plus" />
                            <span className="sr-only">–î–æ–±–∞–≤–∏—Ç—å</span>
                            </button>

                            <button
                            className={`icon-tab ${modalTab === 'export' ? 'active' : ''}`}
                            onClick={() => { setModalTab('export'); }}
                            aria-label="–≠–∫—Å–ø–æ—Ä—Ç"
                            title="–≠–∫—Å–ø–æ—Ä—Ç"
                            >
                            <i className="fas fa-file-export" />
                            <span className="sr-only">–≠–∫—Å–ø–æ—Ä—Ç</span>
                            </button>

                            <button
                            className={`icon-tab ${modalTab === 'import' ? 'active' : ''}`}
                            onClick={() => setModalTab('import')}
                            aria-label="–ò–º–ø–æ—Ä—Ç"
                            title="–ò–º–ø–æ—Ä—Ç"
                            >
                            <i className="fas fa-file-import" />
                            <span className="sr-only">–ò–º–ø–æ—Ä—Ç</span>
                            </button>

                            <div style={{ marginLeft: 'auto' }}>
                            <button
                                className="icon-btn"
                                onClick={() => { setShowAddButtonModal(false); setModalTab('add'); }}
                                aria-label="–ó–∞–∫—Ä—ã—Ç—å"
                                title="–ó–∞–∫—Ä—ã—Ç—å"
                            >
                                <i className="fas fa-times" />
                                <span className="sr-only">–ó–∞–∫—Ä—ã—Ç—å</span>
                            </button>
                            </div>
                        </div>

                        {/* Tab content */}
                        {modalTab === 'add' && (
                            <div>
                            <input
                                type="number"
                                className="number-input"
                                value={newButtonNumber}
                                onChange={(e) => setNewButtonNumber(e.target.value)}
                                placeholder="–ù–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞"
                                min="1"
                            />
                            <div className="compact-row" style={{ marginTop: 10 }}>
                                <button
                                className="icon-btn"
                                onClick={addSingleDeferredButton}
                                aria-label="–î–æ–±–∞–≤–∏—Ç—å / –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å"
                                title="–î–æ–±–∞–≤–∏—Ç—å / –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å"
                                >
                                <i className="fas fa-exchange-alt" />
                                <span className="sr-only">–î–æ–±–∞–≤–∏—Ç—å / –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</span>
                                </button>

                                <button
                                className="icon-btn"
                                onClick={() => { setNewButtonNumber(''); }}
                                aria-label="–û—á–∏—Å—Ç–∏—Ç—å"
                                title="–û—á–∏—Å—Ç–∏—Ç—å"
                                >
                                <i className="fas fa-eraser" />
                                <span className="sr-only">–û—á–∏—Å—Ç–∏—Ç—å</span>
                                </button>
                            </div>
                            </div>
                        )}

                        {modalTab === 'export' && (
                            <div>
                            <p style={{ marginBottom: 8 }}>–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö (JSON)</p>
                            <textarea
                                className="result-textarea"
                                value={getDeferredJson()}
                                readOnly
                                style={{ height: 140 }}
                            />
                            <div style={{ display: 'flex', gap: 8, marginTop: 8, alignItems: 'center' }}>
                                <button
                                className="icon-btn"
                                onClick={() => {
                                    const payload = getDeferredJson();
                                    if (navigator.clipboard && navigator.clipboard.writeText) {
                                    navigator.clipboard.writeText(payload).then(() => showNotification('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä'));
                                    } else {
                                    showNotification('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
                                    }
                                }}
                                aria-label="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON"
                                title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON"
                                >
                                <i className="fas fa-clipboard" />
                                <span className="sr-only">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</span>
                                </button>

                                <button
                                className="icon-btn"
                                onClick={() => { exportDeferred(); }}
                                aria-label="–°–∫–∞—á–∞—Ç—å .json"
                                title="–°–∫–∞—á–∞—Ç—å .json"
                                >
                                <i className="fas fa-download" />
                                <span className="sr-only">–°–∫–∞—á–∞—Ç—å .json</span>
                                </button>
                            </div>
                            </div>
                        )}

                        {modalTab === 'import' && (
                            <div>
                            <p style={{ marginBottom: 8 }}>–ò–º–ø–æ—Ä—Ç: –≤—Å—Ç–∞–≤—å—Ç–µ JSON –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ .json —Ñ–∞–π–ª</p>
                            <textarea
                                className="result-textarea"
                                placeholder='{"deferred":[{"id":"...","num":123,"endTime":..., "restartCount":1}, ...]}'
                                value={importText}
                                onChange={(e) => setImportText(e.target.value)}
                                style={{ height: 140 }}
                            />
                            <div style={{ display: 'flex', gap: 8, marginTop: 8, alignItems: 'center' }}>
                                <button
                                className="icon-btn"
                                onClick={() => {
                                    if (!importText || importText.trim() === '') {
                                    showNotification('–í—Å—Ç–∞–≤—å—Ç–µ JSON –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                                    return;
                                    }
                                    importDeferredFromText(importText);
                                    setImportText('');
                                    setShowAddButtonModal(false);
                                }}
                                aria-label="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–∞"
                                title="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–∞"
                                >
                                <i className="fas fa-paste" />
                                <span className="sr-only">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ —Ç–µ–∫—Å—Ç–∞</span>
                                </button>

                                <label style={{ display: "inline-block" }}>
                                <input type="file" accept="application/json" style={{ display: "none" }} onChange={handleImportFile}/>
                                <button
                                    className="icon-btn"
                                    aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å .json"
                                    title="–ó–∞–≥—Ä—É–∑–∏—Ç—å .json"
                                >
                                    <i className="fas fa-upload" />
                                    <span className="sr-only">–ó–∞–≥—Ä—É–∑–∏—Ç—å .json</span>
                                </button>
                                </label>

                                <button
                                className="icon-btn"
                                onClick={() => setImportText('')}
                                aria-label="–û—á–∏—Å—Ç–∏—Ç—å"
                                title="–û—á–∏—Å—Ç–∏—Ç—å"
                                >
                                <i className="fas fa-eraser" />
                                <span className="sr-only">–û—á–∏—Å—Ç–∏—Ç—å</span>
                                </button>
                            </div>
                            </div>
                        )}

                        </div>
                    </div>
                    )}
                    {showStatusModal && (
                      <div className="modal">
                        <div className="modal-content">
                          <h3>–í—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞</h3>
                          <select
                            value={modalStatus}
                            onChange={(e) => setModalStatus(e.target.value)}
                          >
                            <option value="" disabled>-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
                            {selectedStatus !== "active" && (
                              <option value="active">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</option>
                            )}
                            <option value="break">–ü–µ—Ä–µ—Ä—ã–≤</option>
                            <option value="tech">–¢–µ—Ö. –ø—Ä–∏—á–∏–Ω–∞</option>
                            <option value="training">–¢—Ä–µ–Ω–∏–Ω–≥</option>
                            <option value="iesigning">–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ</option>
                            <option value="inactive">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</option>
                          </select>
                          <div className="modal-buttons">
                            <button
                              onClick={() => {
                                if (modalStatus) {
                                  setSelectedStatus(modalStatus);
                                  toggleActive(modalStatus);
                                  setShowStatusModal(false);
                                }
                              }}
                              disabled={!modalStatus} // –∫–Ω–æ–ø–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω —Å—Ç–∞—Ç—É—Å
                            >
                              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button onClick={() => setShowStatusModal(false)}>–û—Ç–º–µ–Ω–∞</button>
                          </div>
                        </div>
                      </div>
                    )}
                </>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
