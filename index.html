<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Перетаскивание кнопок - Сакура</title>
    <link rel="icon" href="https://iili.io/3soEozX.png"/>
    <style>
        :root {
            --bg-color: #fff5f7;
            --text-color: #4a2f3b;
            --button-bg: #f8b8c6;
            --button-hover: #ffb6c1;
            --column-bg: rgba(255, 245, 247, 0.9);
            --border-color: #f4c4ce;
            --trash-bg: #ff6b6b;
            --trash-hover: #ff5252;
            --notification-bg: #ff8c94;
            --gradient-light: linear-gradient(145deg, #fff0f5, #ffe4e9);
            --gradient-dark: linear-gradient(145deg, #4a2f3b, #6b4e5a);
            --shadow-light: 5px 5px 15px rgba(244, 196, 206, 0.2), -5px -5px 15px rgba(255, 255, 255, 0.7);
            --shadow-dark: 5px 5px 15px rgba(74, 47, 59, 0.3), -5px -5px 15px rgba(255, 255, 255, 0.05);
        }

        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
	    --bg-image: url('https://iili.io/3i4Bo2R.webp');
	    background-color: var(--bg-color);
	    background-image: var(--bg-image), var(--gradient-light, none);
	    background-attachment: fixed;
	    background-size: cover, auto;
	    color: var(--text-color);
	    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	    transition: all 0.4s ease-in-out;
	    margin: 0;
	    min-height: 100vh;
	    padding-bottom: 0px;
	    position: relative;
	    overflow-x: hidden;
	}

        .petals {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .petal {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffb6c1;
            border-radius: 50% 20%;
            opacity: 0.7;
            animation: fall linear infinite;
        }

        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0.7; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0.2; }
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            padding: 15px;
            background: var(--column-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        input {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: var(--shadow-light);
            width: 210px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus {
            outline: 2px solid var(--button-bg);
            box-shadow: 0 0 8px rgba(248, 184, 198, 0.3);
        }

        button {
            position: relative;
            padding: 12px 24px;
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        body.dark button {
            color: #fff;
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 0px 10px rgba(248, 184, 198, 0.3);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 15px;
        }

        .column {
            padding: 20px;
            border-radius: 15px;
            background-color: var(--column-bg);
            box-shadow: var(--shadow-light);
            overflow-y: auto;
            max-height: 600px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            padding-top: 50px;
        }

        .column h2 {
            text-align: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: var(--column-bg);
            z-index: 2;
            padding: 10px;
            font-size: 20px;
        }

        .column.dragover {
            border-color: var(--button-hover);
            transform: scale(1.01);
            background: rgba(248, 184, 198, 0.1);
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            min-height: 100px;
        }

        button.pending { background-color: #f8b8c6; }
        button.completed { background-color: #e0d0d5; }
        button.deferred { background-color: #ff8c94; }
        button.dragging { opacity: 0.6; transform: scale(0.95); }

        button .timer-container {
            position: absolute;
            top: 6px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        button .timer {
            font-size: 12px;
            background-color: rgba(74, 47, 59, 0.6);
            padding: 3px 7px;
            border-radius: 8px;
            color: #fff;
        }

        button .edit-time-btn {
            font-size: 12px;
            background-color: #ff8c94;
            border-radius: 6px;
            padding: 2px 6px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button .edit-time-btn:hover {
            background-color: #ff6b6b;
        }

        .timer-control {
            margin: 6px 3px 0;
            font-size: 12px;
            padding: 4px 10px;
            background-color: #4a2f3b;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }

        .timer-control:hover {
            background-color: #6b4e5a;
        }

        .trash-bin {
            width: 250px;
            height: 50px;
            background-color: var(--trash-bg);
            color: white;
            text-align: center;
            line-height: 50px;
            font-size: 16px;
            border-radius: 10px;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: var(--shadow-light);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .trash-bin:hover,
        .trash-bin.dragover {
            background-color: var(--trash-hover);
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: var(--notification-bg);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            font-size: 16px;
            box-shadow: var(--shadow-light);
        }

        .notification.show {
            display: block;
            animation: fadeInOut 3s ease-in-out forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; }
            100% { opacity: 0; transform: translateY(20px); }
        }

        .clear-btn-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            padding: 15px;
        }

        .clear-btn {
            padding: 12px;
            background-color: var(--trash-bg);
            color: white;
            border: none;
            font-size: 14px;
            border-radius: 10px;
            flex: 1;
            max-width: 200px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background-color: var(--trash-hover);
            transform: translateY(-2px);
        }

	body.dark {
	    --bg-color: #2f1b24;
	    --text-color: #f4c4ce;
	    --button-bg: #e07b8c;
	    --button-hover: #f8b8c6;
	    --column-bg: rgba(47, 27, 36, 0.9);
	    --border-color: #6b4e5a;
	    --trash-bg: #c62828;
	    --trash-hover: #b71c1c;
	    --notification-bg: #ff6b6b;
	    --gradient-light: var(--gradient-dark, none);
	    --shadow-light: var(--shadow-dark, none);
	    --bg-image: url('https://iili.io/3i4BqBa.webp');
	}

        .selected {
            outline: 3px solid #ff8c94;
            background-color: rgba(255, 140, 148, 0.15);
            box-shadow: 0 0 12px rgba(255, 140, 148, 0.5);
            transform: scale(1.02);
        }

        .counter {
            position: absolute;
            top: 10px;
            right: 15px;
            font-weight: bold;
            font-size: 16px;
            color: #fff;
            background-color: var(--button-bg);
            padding: 5px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark .counter {
            background-color: var(--button-bg);
            color: #fff;
        }

        .add-button {
            width: 24px;
            height: 24px;
            padding: 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
      	}
      
      	.add-button:hover {
     		transform: none;
          	background: #fff;
		color: #000;
      	}

        .sidebar-toggle {
            position: fixed;
            top: 35px;
            left: 0px;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1100;
            padding: 0;
          	transition: left 0.3s ease-in-out;
          	border-radius: 0 10px 10px 0;
        }
      
      	.sidebar-toggle.open {
      		left: 300px;
      }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: var(--column-bg);
            box-shadow: var(--shadow-light);
            padding: 20px;
            z-index: 1050;
            transition: left 0.3s ease-in-out;
            overflow-y: auto;
        }
        .sidebar input {
            width: 100%;    
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chekmarkbox {
            display: flex;
        }

        .chekmarkbox > input {
            width: 16px;
          	margin-right: 10px;
        }

        .name-item {
            display: grid;
            grid-template-columns: 60% 30%;
        }

        .name-item > button {
        	font-size: 12px;
          	padding 8px 16px;
      	}

        .name-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }

        .name-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .name-item:last-child {
            border-bottom: none;
        }

        .result-textarea {
            width: 100%;
            height: 100px;
            resize: none;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: var(--shadow-light);
        }

        .login-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--column-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            width: 300px;
            text-align: center;
        }

        .login-container h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }

        .login-container input {
            width: 100%;
            margin-bottom: 15px;
        }

        .login-container button {
            width: 100%;
        }

        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--column-bg);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            z-index: 100;
        }

        .user-info span {
            font-weight: bold;
        }

        .user-info button {
            padding: 8px 16px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container { width: 95%; margin: 15px auto; }
            .controls { flex-direction: column; align-items: center; padding: 10px; }
            input { width: 100%; max-width: 300px; }
            .columns { grid-template-columns: 1fr; gap: 15px; }
            .column { width: 100%; max-height: 500px; }
            .clear-btn { width: 100%; max-width: none; }
            .trash-bin { width: 200px; height: 45px; line-height: 45px; font-size: 14px; right: 10px; bottom: 10px; }
            .notification { bottom: 70px; right: 10px; max-width: 90%; }
            .sidebar { width: 250px; }
            .sidebar.open { left: 0; }
            .sidebar-toggle { width: 40px; height: 40px; font-size: 20px; }
            .login-container { width: 90%; padding: 20px; }
            .user-info { top: 10px; right: 10px; flex-direction: column; gap: 5px; padding: 8px; }
        }
      
      	::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--column-bg);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border-radius: 10px;
            border: 2px solid var(--column-bg); /* for padding-like effect */
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--button-hover);
        }
	body.dark ::-webkit-scrollbar-thumb {
  	   background-color: var(--button-bg);
 	   border: 2px solid var(--column-bg);
	}

	body.dark ::-webkit-scrollbar-thumb:hover {
   	   background-color: var(--button-hover);
	}
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_BASE_URL = "https://otp-2-fos4.onrender.com";

        const App = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [names, setNames] = useState(['Руслан', 'Жанасыл', 'Шерзад', 'Нурсерик', 'Азана', 'Асель', 'Анель', 'Балауса', 'Шугыла', 'Алуа']);
            const [buttons, setButtons] = useState({ pending: [], completed: [], deferred: [] });
            const [selectedButtons, setSelectedButtons] = useState([]);
            const [notification, setNotification] = useState({ message: '', show: false });
            const [fromValue, setFromValue] = useState('');
            const [toValue, setToValue] = useState('');
            const [stepValue, setStepValue] = useState('');
            const [nameInput, setNameInput] = useState('');
            const [startButton, setStartButton] = useState('');
            const [result, setResult] = useState('');
            const timersRef = useRef(new Map());
            const petalsRef = useRef(null);
            const [loggedIn, setLoggedIn] = useState(false);
            const [userData, setUserData] = useState(null);
            const [loginValue, setLoginValue] = useState('');
            const [passwordValue, setPasswordValue] = useState('');

            useEffect(() => {
                document.body.classList.toggle('dark', theme === 'dark');
            }, [theme]);

            useEffect(() => {
                createPetals();
                loadColumnState();
                requestPermissions();
                const storedUser = localStorage.getItem('userData');
                if (storedUser) {
                    setUserData(JSON.parse(storedUser));
                    setLoggedIn(true);
                }
            }, []);

            const handleLogin = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ login: loginValue, password: passwordValue })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        setUserData(data);
                        setLoggedIn(true);
                        localStorage.setItem('userData', JSON.stringify(data));
                        showNotification('Login successful!');
                    } else {
                        showNotification(data.error || 'Invalid credentials');
                    }
                } catch (e) {
                    showNotification('Error: ' + e.message);
                }
            };

            const handleLogout = () => {
                setLoggedIn(false);
                setUserData(null);
                localStorage.removeItem('userData');
                showNotification('Logged out');
            };

            const toggleTheme = () => {
                const newTheme = theme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            };

            const toggleSidebar = () => {
                setSidebarOpen(!sidebarOpen);
            };

            const createPetals = () => {
                const petalsContainer = petalsRef.current;
                if (!petalsContainer) return;
                for (let i = 0; i < 20; i++) {
                    const petal = document.createElement('div');
                    petal.classList.add('petal');
                    petal.style.left = `${Math.random() * 100}vw`;
                    petal.style.animationDuration = `${Math.random() * 5 + 5}s`;
                    petal.style.animationDelay = `${Math.random() * 5}s`;
                    petalsContainer.appendChild(petal);
                }
            };

            const requestPermissions = () => {
                try {
                    const testWindow = window.open('', '_blank');
                    if (testWindow) {
                        testWindow.close();
                    } else {
                        showNotification('Всплывающие окна заблокированы. Пожалуйста, разрешите их в настройках браузера.');
                    }
                } catch (e) {
                    showNotification('Всплывающие окна заблокированы. Пожалуйста, разрешите их в настройках браузера.');
                }
            };

            const loadColumnState = () => {
                const loadedButtons = {};
                ['pending', 'completed', 'deferred'].forEach(columnId => {
                    const buttonIds = JSON.parse(localStorage.getItem(`${columnId}Buttons`) || '[]');
                    loadedButtons[columnId] = buttonIds.map(id => ({ id, num: id.split('-')[1] }));
                });
                setButtons(loadedButtons);
                // Restore timers for deferred
                loadedButtons.deferred.forEach(btn => {
                    const endTime = localStorage.getItem(`timer_${btn.id}`);
                    if (endTime) {
                        const remaining = Math.floor((parseInt(endTime) - Date.now()) / 1000);
                        if (remaining > 0) {
                            startTimer(btn.id, remaining);
                        }
                    }
                });
            };

            const saveColumnState = () => {
                Object.keys(buttons).forEach(columnId => {
                    const buttonIds = buttons[columnId].map(btn => btn.id);
                    localStorage.setItem(`${columnId}Buttons`, JSON.stringify(buttonIds));
                });
            };

            const showNotification = (message) => {
                setNotification({ message, show: true });
                setTimeout(() => setNotification({ message: '', show: false }), 3000);
            };

            const addButtons = () => {
                const from = parseInt(fromValue);
                const to = parseInt(toValue);
                const step = parseInt(stepValue);
                if (isNaN(from) || isNaN(to) || isNaN(step) || from < 1 || to < 1 || step < 1 || from > to) {
                    showNotification('Введите корректные положительные числа!');
                    return;
                }
                const newPending = [...buttons.pending];
                for (let i = from; i <= to; i += step) {
                    const id = `button-${i}`;
                    if (!Object.values(buttons).flat().some(b => b.id === id)) {
                        newPending.push({ id, num: i });
                    }
                }
                setButtons({ ...buttons, pending: newPending });
                saveColumnState();
                showNotification('Кнопки добавлены!');
            };

            const addSingleDeferredButton = () => {
                const num = prompt('Введите номер кнопки для добавления в Отложенные:');
                const parsedNum = parseInt(num);
                if (isNaN(parsedNum) || parsedNum < 1) return showNotification('Введите корректный номер!');
                const id = `button-${parsedNum}`;
                if (Object.values(buttons).flat().some(b => b.id === id)) return showNotification('Кнопка уже существует!');
                const newDeferred = [...buttons.deferred, { id, num: parsedNum }];
                setButtons({ ...buttons, deferred: newDeferred });
                startTimer(id, 900); // initial 15 min
                saveColumnState();
                showNotification(`Кнопка ${parsedNum} добавлена!`);
            };

            const startTimer = (id, duration) => {
                const endTime = Date.now() + duration * 1000;
                localStorage.setItem(`timer_${id}`, endTime);
                const interval = setInterval(() => {
                    const timeLeft = Math.max(0, Math.floor((endTime - Date.now()) / 1000));
                    const timerEl = document.getElementById(`timer-${id}`);
                    if (timerEl) {
                        const minutes = Math.floor(timeLeft / 60);
                        const seconds = timeLeft % 60;
                        timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }
                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        timersRef.current.delete(id);
                        localStorage.removeItem(`timer_${id}`);
                        const buttonId = id.split('-')[1];
                        window.open(`https://backend.yataxi.kz/admin/list-tickets/${buttonId}`, '_blank');
                        setButtons(prev => ({ ...prev })); // Force re-render
                    }
                }, 1000);
                timersRef.current.set(id, interval);
            };

            const promptForCustomTime = (id) => {
                const userInput = prompt('Введите время в минутах:');
                const customDuration = parseFloat(userInput);
                if (isNaN(customDuration) || customDuration <= 0) return showNotification('Некорректное число!');
                const seconds = Math.floor(customDuration * 60);
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                startTimer(id, seconds);
            };

            const restartTimer = (id) => {
                let restartCount = parseInt(localStorage.getItem(`restartCount_${id}`) || '0');
                restartCount++;
                localStorage.setItem(`restartCount_${id}`, restartCount);
                const duration = restartCount === 1 ? 1800 : 3600;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                startTimer(id, duration);
                setButtons(prev => ({ ...prev })); // Re-render
            };

            const completeTask = (id, column) => {
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                if (timersRef.current.has(id)) {
                    clearInterval(timersRef.current.get(id));
                    timersRef.current.delete(id);
                }
                setButtons(prev => {
                    const btn = prev.deferred.find(b => b.id === id);
                    if (!btn) return prev;
                    return {
                        ...prev,
                        deferred: prev.deferred.filter(b => b.id !== id),
                        completed: [...prev.completed, btn]
                    };
                });
                saveColumnState();
            };

            const handleButtonClick = (e, btn, column) => {
                if (e.ctrlKey || e.metaKey) {
                    setSelectedButtons(prev => prev.some(s => s.id === btn.id) ? prev.filter(s => s.id !== btn.id) : [...prev, {...btn, column}]);
                } else {
                    setSelectedButtons([{...btn, column}]);
                }
            };

            const openSelectedInTabs = () => {
                if (selectedButtons.length === 0) return showNotification('Выберите кнопку!');
                selectedButtons.forEach(btn => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank'));
            };

            const deleteButton = (btn) => {
                if (!confirm('Уверены?')) return;
                const id = btn.id;
                if (timersRef.current.has(id)) clearInterval(timersRef.current.get(id));
                timersRef.current.delete(id);
                localStorage.removeItem(`timer_${id}`);
                localStorage.removeItem(`restartCount_${id}`);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    Object.keys(newButtons).forEach(col => {
                        newButtons[col] = newButtons[col].filter(b => b.id !== id);
                    });
                    return newButtons;
                });
                saveColumnState();
                setSelectedButtons(prev => prev.filter(s => s.id !== id));
                showNotification('Кнопка удалена!');
            };

            const dragStart = (e, btn) => {
                e.dataTransfer.setData('text/plain', JSON.stringify(btn));
                e.target.classList.add('dragging');
            };

            const dragEnd = (e) => {
                e.target.classList.remove('dragging');
            };

            const allowDrop = (e) => {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            };

            const drop = (e, targetColumn) => {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                setSelectedButtons([]);
                setButtons(prev => {
                    const newButtons = { ...prev };
                    selectedButtons.forEach(selBtn => {
                        Object.keys(newButtons).forEach(col => {
                            newButtons[col] = newButtons[col].filter(b => b.id !== selBtn.id);
                        });
                        newButtons[targetColumn].push(selBtn);
                        if (targetColumn === 'deferred') {
                            startTimer(selBtn.id, 900);
                        } else if (selBtn.column === 'deferred') {
                            if (timersRef.current.has(selBtn.id)) clearInterval(timersRef.current.get(selBtn.id));
                            timersRef.current.delete(selBtn.id);
                            localStorage.removeItem(`timer_${selBtn.id}`);
                            localStorage.removeItem(`restartCount_${selBtn.id}`);
                        }
                    });
                    return newButtons;
                });
                saveColumnState();
            };

            const dropInTrash = (e) => {
                e.preventDefault();
                document.getElementById('trashBin').classList.remove('dragover');
                selectedButtons.forEach(selBtn => deleteButton(selBtn));
            };

            const clearColumn = (columnId) => {
                buttons[columnId].forEach(btn => {
                    if (timersRef.current.has(btn.id)) clearInterval(timersRef.current.get(btn.id));
                    timersRef.current.delete(btn.id);
                    localStorage.removeItem(`timer_${btn.id}`);
                    localStorage.removeItem(`restartCount_${btn.id}`);
                });
                setButtons(prev => ({ ...prev, [columnId]: [] }));
                saveColumnState();
                showNotification(`Колонка "${columnId}" очищена!`);
            };

            const addName = () => {
                const name = nameInput.trim();
                if (name && !names.includes(name)) {
                    setNames([...names, name]);
                    setNameInput('');
                    showNotification('Имя добавлено!');
                } else {
                    showNotification('Введите уникальное имя!');
                }
            };

            const deleteName = (index) => {
                setNames(prev => prev.filter((_, i) => i !== index));
                showNotification('Имя удалено!');
            };

            const divideButtons = () => {
                const start = parseInt(startButton);
                if (isNaN(start) || start < 1) return showNotification('Введите корректный номер!');
                const selectedNames = names.filter((_, index) => document.getElementById(`checkbox-${index}`)?.checked);
                if (selectedNames.length === 0) return showNotification('Выберите имя!');
                const res = selectedNames.map((name, index) => `${start + index} - ${name}`).join('\n');
                setResult(res);
                showNotification('Кнопки поделены!');
            };

            const copyResult = () => {
                navigator.clipboard.writeText(result);
                showNotification('Текст скопирован!');
            };

            const renderButton = (btn, column) => {
                const id = btn.id;
                const endTime = localStorage.getItem(`timer_${id}`);
                const hasTimer = column === 'deferred' && endTime && (parseInt(endTime) > Date.now());
                const showControls = column === 'deferred' && !hasTimer;
                const isSelected = selectedButtons.some(s => s.id === id);
                return (
                    <button
                        key={id}
                        id={id}
                        className={`${column} ${isSelected ? 'selected' : ''}`}
                        draggable
                        onDragStart={(e) => dragStart(e, btn)}
                        onDragEnd={dragEnd}
                        onClick={(e) => handleButtonClick(e, btn, column)}
                        onDoubleClick={() => window.open(`https://backend.yataxi.kz/admin/list-tickets/${btn.num}`, '_blank')}
                        onContextMenu={(e) => { e.preventDefault(); deleteButton(btn); }}
                    >
                        Кнопка {btn.num}
                        {column === 'deferred' && (
                            <div className="timer-container">
                                {hasTimer && (
                                    <>
                                        <div className="timer" id={`timer-${id}`}></div>
                                        <button className="edit-time-btn" onClick={() => promptForCustomTime(id)}>🖋️</button>
                                    </>
                                )}
                            </div>
                        )}
                        {showControls && (
                            <>
                                <button className="timer-control" onClick={() => restartTimer(id)}>↻</button>
                                <button className="timer-control" onClick={() => completeTask(id, column)}>✔</button>
                            </>
                        )}
                    </button>
                );
            };

            if (!loggedIn) {
                return (
                    <div className="login-container">
                        <h2>Вход в аккаунт</h2>
                        <input type="text" value={loginValue} onChange={(e) => setLoginValue(e.target.value)} placeholder="Логин" />
                        <input type="password" value={passwordValue} onChange={(e) => setPasswordValue(e.target.value)} placeholder="Пароль" />
                        <button onClick={handleLogin}>Войти</button>
                        <div className={`notification ${notification.show ? 'show' : ''}`}>{notification.message}</div>
                    </div>
                );
            }

            return (
                <>
                    <div className="petals" ref={petalsRef}></div>
                    <button className={`sidebar-toggle ${sidebarOpen ? 'open' : ''}`} onClick={toggleSidebar} aria-label="Открыть меню разделения кнопок">📝</button>
                    <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
                        <div className="sidebar-content">
                            <h3 style={{ textAlign: 'center' }}>Тикето-дробилка</h3>
                            <input value={nameInput} onChange={(e) => setNameInput(e.target.value)} placeholder="Введите имя" />
                            <button onClick={addName}>Добавить имя</button>
                            <h3>Список имен</h3>
                            <div className="name-list">
                                {names.map((name, index) => (
                                    <div key={index} className="name-item">
                                        <label className="chekmarkbox">
                                            <input type="checkbox" id={`checkbox-${index}`} defaultChecked />
                                            {name}
                                        </label>
                                        <button onClick={() => deleteName(index)}>Удалить</button>
                                    </div>
                                ))}
                            </div>
                            <h3>Поделить</h3>
                            <input type="number" value={startButton} onChange={(e) => setStartButton(e.target.value)} placeholder="Начальный номер кнопки" />
                            <button onClick={divideButtons}>Поделить</button>
                            <h3>Результат</h3>
                            <textarea className="result-textarea" value={result} readOnly />
                            <button onClick={copyResult}>Скопировать</button>
                        </div>
                    </div>
                    {userData && (
                        <div className="user-info">
                            <span>{userData.name}</span>
                            <button onClick={handleLogout}>Выйти</button>
                        </div>
                    )}
                    <div className="container">
                        <div className="controls">
                            <button onClick={toggleTheme} aria-label="Переключить тему">
                                <span>{theme === 'dark' ? '☀️' : '🌙'}</span>
                            </button>
                            <input type="number" value={fromValue} onChange={(e) => setFromValue(e.target.value)} placeholder="С какой кнопки" />
                            <input type="number" value={toValue} onChange={(e) => setToValue(e.target.value)} placeholder="До какой кнопки" />
                            <input type="number" value={stepValue} onChange={(e) => setStepValue(e.target.value)} placeholder="Шаг" />
                            <button onClick={addButtons} aria-label="Добавить кнопки">Добавить кнопки</button>
                            <button onClick={openSelectedInTabs} aria-label="Открыть выбранные">Открыть выбранные</button>
                        </div>
                        <div className="columns">
                            {['pending', 'completed', 'deferred'].map(column => (
                                <div
                                    key={column}
                                    className="column"
                                    id={column}
                                    onDrop={(e) => drop(e, column)}
                                    onDragOver={allowDrop}
                                    onDragLeave={(e) => e.currentTarget.classList.remove('dragover')}
                                >
                                    <h2>{column === 'pending' ? 'Выполняемые' : column === 'completed' ? 'Выполненные' : 'Отложенные'}</h2>
                                    <div className="list" id={`${column}List`}>
                                        {buttons[column].map(btn => renderButton(btn, column))}
                                    </div>
                                    <div className="counter" id={`${column}Count`}>
                                        {buttons[column].length}
                                        {column === 'deferred' && <button className="add-button" onClick={addSingleDeferredButton}>+</button>}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="clear-btn-container">
                            <button className="clear-btn" onClick={() => clearColumn('pending')}>Очистить Выполняемые</button>
                            <button className="clear-btn" onClick={() => clearColumn('completed')}>Очистить Выполненные</button>
                            <button className="clear-btn" onClick={() => clearColumn('deferred')}>Очистить Отложенные</button>
                        </div>
                    </div>
                    <div className="trash-bin" id="trashBin" onDragOver={(e) => { e.preventDefault(); document.getElementById('trashBin').classList.add('dragover'); }} onDrop={dropInTrash} onDragLeave={() => document.getElementById('trashBin').classList.remove('dragover')}>
                        Перетащите сюда для удаления
                    </div>
                    <div className={`notification ${notification.show ? 'show' : ''}`} id="notification">
                        {notification.message}
                    </div>
                </>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
